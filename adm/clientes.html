<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Clientes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {background:#f4f6f9; padding:20px;}
h1 {color:#2c3e50; margin-bottom:20px;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; color:white; position:relative; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.card h3 {font-size:14px; margin-bottom:10px;}
.card p {font-size:18px; font-weight:700;}
.card.total {background:#2980b9;}
.card.novos {background:#1abc9c;}
.card.fidelizados {background:#27ae60;}
.card.vip {background:#8e44ad;}
.card.alerta {background:#e74c3c;}
.card.ticket {background:#f39c12;}
.card.freq {background:#16a085;}
.card.clv {background:#d35400;}
.filters {display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-bottom:20px;}
.filters input, .filters select {padding:10px; border-radius:5px; border:1px solid #ccc;}
.filters button {padding:10px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.filters button:hover {background:#3498db;}
.graphs {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-top:20px;}
canvas {background:#fff; border-radius:10px; padding:10px;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
.modal-content {background:#fff; padding:20px; border-radius:10px; max-width:500px; width:100%; position:relative;}
.modal-content h2 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px;}
.modal-content input, .modal-content select {width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer;}
.modal-content .close {position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px;}
</style>
</head>
<body>

<h1>Clientes</h1>

<div class="cards">
<div class="card total"><h3>Total de Clientes</h3><p id="totalClientes">0</p></div>
<div class="card novos"><h3>Novos no Mês</h3><p id="clientesNovos">0</p></div>
<div class="card fidelizados"><h3>Fidelizados</h3><p id="clientesFidelizados">0</p></div>
<div class="card vip"><h3>VIP</h3><p id="clientesVIP">0</p></div>
<div class="card alerta"><h3>Aniversário Próximo</h3><p id="clientesAniversario">0</p></div>
<div class="card ticket"><h3>Ticket Médio</h3><p id="ticketMedio">0</p></div>
<div class="card freq"><h3>Frequência Média</h3><p id="frequenciaMedia">0</p></div>
<div class="card clv"><h3>CLV Médio</h3><p id="clvMedio">0</p></div>
</div>

<div class="filters">
<input type="text" id="filtroNome" placeholder="Nome">
<select id="filtroStatus">
  <option value="">Status</option>
  <option value="ativo">Ativo</option>
  <option value="inativo">Inativo</option>
  <option value="VIP">VIP</option>
  <option value="fidelizado">Fidelizado</option>
</select>
<select id="filtroIdade">
  <option value="">Faixa Etária</option>
  <option value="0-1">0-1 anos</option>
  <option value="2-5">2-5 anos</option>
  <option value="6-10">6-10 anos</option>
  <option value="11+">11+ anos</option>
</select>
<select id="filtroProdutos" multiple>
  <option value="ração">Ração</option>
  <option value="petiscos">Petiscos</option>
  <option value="acessórios">Acessórios</option>
  <option value="medicamentos">Medicamentos</option>
</select>
<select id="filtroServicos" multiple>
  <option value="banho">Banho</option>
  <option value="tosa">Tosa</option>
  <option value="creche">Creche</option>
  <option value="consulta">Consulta</option>
</select>
<button id="btnAplicarFiltro">Aplicar Filtros</button>
</div>

<div class="graphs">
<canvas id="graficoTicketMedio"></canvas>
<canvas id="graficoFrequencia"></canvas>
<canvas id="graficoCLV"></canvas>
<canvas id="graficoIdade"></canvas>
</div>

<div id="modalCliente" class="modal">
<div class="modal-content">
<span class="close" onclick="fecharModal()">&times;</span>
<h2>Editar Cliente</h2>
<label>Nome</label><input type="text" id="modalNome">
<label>E-mail</label><input type="email" id="modalEmail">
<label>Telefone</label><input type="text" id="modalTelefone">
<label>CPF</label><input type="text" id="modalCPF">
<label>Status</label>
<select id="modalStatus">
  <option value="ativo">Ativo</option>
  <option value="inativo">Inativo</option>
  <option value="VIP">VIP</option>
  <option value="fidelizado">Fidelizado</option>
</select>
<button onclick="salvarCliente()">Salvar Alterações</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
// Configuração Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Função idade
function calcularIdade(nasc){const hoje=new Date();const dataN=new Date(nasc);let idade=hoje.getFullYear()-dataN.getFullYear();const m=hoje.getMonth()-dataN.getMonth();if(m<0||(m===0&&hoje.getDate()<dataN.getDate())) idade--;return idade;}

// Variáveis gráficos
let graficoTicket,graficoFreq,graficoCLV,graficoIdade;
let clientesData=[];

// Carregar clientes
db.collection("clientes").onSnapshot(snapshot=>{
    clientesData=[];
    snapshot.forEach(doc=>{const c=doc.data();c.id=doc.id;clientesData.push(c);});
    atualizarDashboards(clientesData);
});

// Atualizar dashboards
function atualizarDashboards(data){
    // KPIs
    const hoje=new Date();
    let total=0,novos=0,fidelizados=0,vip=0,aniversarios=0,ticket=0,freq=0,clv=0;
    data.forEach(c=>{
        total++;
        if(c.fidelizado) fidelizados++;
        if(c.vip) vip++;
        if(c.cadastro && new Date(c.cadastro) >= new Date(hoje.getFullYear(), hoje.getMonth()-1, hoje.getDate())) novos++;
        if(c.nascimento){
            const nasc=new Date(c.nascimento);
            const prox=new Date(hoje.getFullYear(), nasc.getMonth(), nasc.getDate());
            const diff=(prox-hoje)/(1000*60*60*24);
            if(diff>=0&&diff<=7) aniversarios++;
        }
        if(c.compras && c.compras.length>0){
            const totalCompra=c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0);
            ticket+=totalCompra/c.compras.length;
            freq+=c.compras.length;
            clv+=totalCompra;
        }
    });
    const n=data.length||1;
    document.getElementById('totalClientes').textContent=total;
    document.getElementById('clientesNovos').textContent=novos;
    document.getElementById('clientesFidelizados').textContent=fidelizados;
    document.getElementById('clientesVIP').textContent=vip;
    document.getElementById('clientesAniversario').textContent=aniversarios;
    document.getElementById('ticketMedio').textContent=ticket.toFixed(2);
    document.getElementById('frequenciaMedia').textContent=(freq/n).toFixed(1);
    document.getElementById('clvMedio').textContent=(clv/n).toFixed(2);

    atualizarGraficos(data);
}

// Atualizar gráficos
function atualizarGraficos(data){
    const labels=data.map(c=>c.nome);
    const ticket=data.map(c=>c.compras&&c.compras.length>0?c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0)/c.compras.length:0);
    const freq=data.map(c=>c.compras?c.compras.length:0);
    const clv=data.map(c=>c.compras?c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0):0);

    const idadeLabels=["0-1","2-5","6-10","11+"];
    const idadeData=[0,0,0,0];
    data.forEach(c=>{if(c.nascimento){const i=calcularIdade(c.nascimento);if(i<=1)idadeData[0]++;else if(i<=5)idadeData[1]++;else if(i<=10)idadeData[2]++;else idadeData[3]++;}});

    if(graficoTicket) graficoTicket.destroy();
    graficoTicket=new Chart(document.getElementById('graficoTicketMedio').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Ticket Médio',data:ticket,backgroundColor:'#2980b9'}]}});

    if(graficoFreq) graficoFreq.destroy();
    graficoFreq=new Chart(document.getElementById('graficoFrequencia').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Frequência',data:freq,backgroundColor:'#16a085'}]}});

    if(graficoCLV) graficoCLV.destroy();
    graficoCLV=new Chart(document.getElementById('graficoCLV').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'CLV',data:clv,backgroundColor:'#d35400'}]}});

    if(graficoIdade) graficoIdade.destroy();
    graficoIdade=new Chart(document.getElementById('graficoIdade').getContext('2d'),{type:'pie',data:{labels:idadeLabels,datasets:[{data:idadeData,backgroundColor:['#1abc9c','#27ae60','#8e44ad','#e74c3c']}]}} );
}

// Filtros
document.getElementById('btnAplicarFiltro').addEventListener('click',()=>{
    let filtrados=[...clientesData];
    const nome=document.getElementById('filtroNome').value.toLowerCase();
    const status=document.getElementById('filtroStatus').value;
    const idade=document.getElementById('filtroIdade').value;
    const produtos=[...document.getElementById('filtroProdutos').selectedOptions].map(o=>o.value);
    const servicos=[...document.getElementById('filtroServicos').selectedOptions].map(o=>o.value);

    filtrados=filtrados.filter(c=>{
        let ok=true;
        if(nome&&!c.nome.toLowerCase().includes(nome)) ok=false;
        if(status&&c.status!==status) ok=false;
        if(idade&&c.nascimento){const i=calcularIdade(c.nascimento);
            if(idade==="0-1"&&!(i>=0&&i<=1)) ok=false;
            if(idade==="2-5"&&!(i>=2&&i<=5)) ok=false;
            if(idade==="6-10"&&!(i>=6&&i<=10)) ok=false;
            if(idade==="11+"&&!(i>=11)) ok=false;
        }
        if(produtos.length>0&&(!c.compras||!c.compras.some(p=>produtos.includes(p.tipo)))) ok=false;
        if(servicos.length>0&&(!c.agendamentos||!c.agendamentos.some(s=>servicos.includes(s.servico)))) ok=false;
        return ok;
    });
    atualizarDashboards(filtrados);
});

// Modal
function abrirModal(cliente){
    document.getElementById('modalCliente').style.display='flex';
    document.getElementById('modalNome').value=cliente.nome||'';
    document.getElementById('modalEmail').value=cliente.email||'';
    document.getElementById('modalTelefone').value=cliente.telefone||'';
    document.getElementById('modalCPF').value=cliente.cpf||'';
    document.getElementById('modalStatus').value=cliente.status||'ativo';
    document.getElementById('modalCliente').dataset.id=cliente.id;
}
function fecharModal(){document.getElementById('modalCliente').style.display='none';}

// Salvar alterações
function salvarCliente(){
    const id=document.getElementById('modalCliente').dataset.id;
    db.collection("clientes").doc(id).update({
        nome:document.getElementById('modalNome').value,
        email:document.getElementById('modalEmail').value,
        telefone:document.getElementById('modalTelefone').value,
        cpf:document.getElementById('modalCPF').value,
        status:document.getElementById('modalStatus').value
    }).then(()=>{fecharModal(); alert('Alterações salvas!');});
}
</script>
</body>
</html>
