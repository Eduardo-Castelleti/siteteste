<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Clientes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:red; color:white; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.novos {background:#1abc9c;}
.card.fidelizados {background:#27ae60;}
.card.vip {background:#8e44ad;}
.card.alerta {background:#e74c3c;}
.card.servicos {background:#f39c12;}
.card.produtos {background:#16a085;}
.search-bar {margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; flex-wrap:wrap;}
.search-bar input, .search-bar select {padding:10px; border-radius:5px; border:1px solid #ccc;}
.search-bar button {padding:10px 15px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.search-bar button:hover {background:#3498db;}
.modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;}
.modal-content {background:#fff; padding:20px; border-radius:10px; width:400px; max-width:90%;}
.modal-content h3 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px;}
.modal-content input, .modal-content select {width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
.modal-content button:hover {background:#2ecc71;}
</style>
</head>
<body>

<div class="sidebar">
<h2>Admin Pet</h2>
<a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
<a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
<a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
<a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
<a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
<a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
<a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
<a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
<a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
<a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
<a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
<a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<div class="main-content">
<h1>Clientes <button onclick="abrirModal()">Consultar Cliente</button></h1>

<div class="cards">
<div class="card total"><h3>Total de Clientes</h3><p id="totalClientes">0</p></div>
<div class="card novos"><h3>Novos no Mês</h3><p id="clientesNovos">0</p></div>
<div class="card fidelizados"><h3>Fidelizados</h3><p id="clientesFidelizados">0</p></div>
<div class="card vip"><h3>VIP</h3><p id="clientesVIP">0</p></div>
<div class="card alerta"><h3>Aniversário Próximo</h3><p id="clientesAniversario">0</p></div>
<div class="card servicos"><h3>Serviços Realizados</h3><p id="totalServicos">0</p></div>
<div class="card produtos"><h3>Produtos Comprados</h3><p id="totalProdutos">0</p></div>
</div>

<div class="search-bar">
<input type="text" id="buscaCliente" placeholder="Pesquisar por nome">
<select id="filtroStatus" multiple><option value="ativo">Ativo</option><option value="inativo">Inativo</option><option value="VIP">VIP</option><option value="fidelizado">Fidelizado</option></select>
<select id="filtroIdade" multiple><option value="0-1">0-1 anos</option><option value="2-5">2-5 anos</option><option value="6-10">6-10 anos</option><option value="11+">11+ anos</option></select>
<select id="filtroServicos" multiple></select>
<select id="filtroProdutos" multiple></select>
<button id="btnFiltrar"><i class="fas fa-search"></i> Filtrar</button>
<button id="btnExportar"><i class="fas fa-file-csv"></i> Exportar CSV</button>
</div>

<div class="graphs">
<canvas id="graficoTicketMedio"></canvas>
<canvas id="graficoFaixaGasto"></canvas>
<canvas id="graficoFrequencia"></canvas>
<canvas id="graficoIdade"></canvas>
</div>

<!-- Modal para consulta/edição -->
<div class="modal" id="modalCliente">
<div class="modal-content">
<h3>Consultar / Editar Cliente</h3>
<label>Nome</label><input type="text" id="modalNome">
<label>E-mail</label><input type="email" id="modalEmail">
<label>Telefone</label><input type="text" id="modalTelefone">
<label>CPF</label><input type="text" id="modalCPF">
<label>Status</label>
<select id="modalStatus"><option value="ativo">Ativo</option><option value="inativo">Inativo</option><option value="VIP">VIP</option><option value="fidelizado">Fidelizado</option></select>
<button onclick="salvarAlteracoes()">Salvar</button>
<button onclick="fecharModal()" style="background:#e74c3c;margin-left:10px;">Fechar</button>
<div id="mensagemModal" style="margin-top:10px;font-weight:500;"></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Modal
let clienteAtual=null;
function abrirModal(){document.getElementById('modalCliente').style.display='flex';}
function fecharModal(){document.getElementById('modalCliente').style.display='none'; document.getElementById('mensagemModal').textContent='';}

// Carregar filtros dinâmicos de serviços e produtos
let servicosSet=new Set();
let produtosSet=new Set();
db.collection("clientes").get().then(snapshot=>{
 snapshot.forEach(doc=>{
   const c=doc.data();
   if(c.servicos) c.servicos.forEach(s=>servicosSet.add(s));
   if(c.produtos) c.produtos.forEach(p=>produtosSet.add(p));
 });
 const filtroServ=document.getElementById('filtroServicos');
 const filtroProd=document.getElementById('filtroProdutos');
 servicosSet.forEach(s=>filtroServ.innerHTML+=`<option value="${s}">${s}</option>`);
 produtosSet.forEach(p=>filtroProd.innerHTML+=`<option value="${p}">${p}</option>`);
});

// Funções para KPIs e gráficos
function calcularIdade(nasc){const hoje=new Date();const dataNasc=new Date(nasc);let idade=hoje.getFullYear()-dataNasc.getFullYear();const m=hoje.getMonth()-dataNasc.getMonth();if(m<0||(m===0&&hoje.getDate()<dataNasc.getDate()))idade--;return idade;}

// Atualizar KPIs e gráficos com filtros
function atualizarKPIs(clientes){
 let total=0, novos=0, fidelizados=0, vip=0, aniversarios=0, totalServ=0, totalProd=0;
 const hoje=new Date();
 clientes.forEach(c=>{
   const idade = c.nascimento ? calcularIdade(c.nascimento) : 0;
   if(c.status==="ativo") total++;
   if(c.vip) vip++;
   if(c.fidelizado) fidelizados++;
   if(new Date(c.cadastro) >= new Date(hoje.getFullYear(), hoje.getMonth()-1, hoje.getDate())) novos++;
   if(c.nascimento){const nasc=new Date(c.nascimento);const prox=new Date(hoje.getFullYear(),nasc.getMonth(),nasc.getDate());const diff=(prox-hoje)/(1000*60*60*24);if(diff>=0 && diff<=7) aniversarios++;}
   if(c.servicos) totalServ+=c.servicos.length;
   if(c.produtos) totalProd+=c.produtos.length;
 });
 document.getElementById('totalClientes').textContent=total;
 document.getElementById('clientesNovos').textContent=novos;
 document.getElementById('clientesFidelizados').textContent=fidelizados;
 document.getElementById('clientesVIP').textContent=vip;
 document.getElementById('clientesAniversario').textContent=aniversarios;
 document.getElementById('totalServicos').textContent=totalServ;
 document.getElementById('totalProdutos').textContent=totalProd;
 // Aqui você pode atualizar os gráficos também usando os clientes filtrados
}

// Filtro
document.getElementById('btnFiltrar').addEventListener('click',()=>{
 db.collection("clientes").get().then(snapshot=>{
   let resultados=[];
   snapshot.forEach(doc=>{resultados.push(doc.data());});
   const busca=document.getElementById('buscaCliente').value.toLowerCase();
   const statusSel=[...document.getElementById('filtroStatus').selectedOptions].map(o=>o.value);
   const idadeSel=[...document.getElementById('filtroIdade').selectedOptions].map(o=>o.value);
   const servSel=[...document.getElementById('filtroServicos').selectedOptions].map(o=>o.value);
   const prodSel=[...document.getElementById('filtroProdutos').selectedOptions].map(o=>o.value);
   const filtrados=resultados.filter(c=>{
     let incluir=true;
     if(busca && !c.nome.toLowerCase().includes(busca)) incluir=false;
     if(statusSel.length && !statusSel.includes(c.status)) incluir=false;
     if(idadeSel.length){
       const idade=c.nascimento ? calcularIdade(c.nascimento) : 0;
       let ok=false;
       idadeSel.forEach(f=>{
         if(f==="0-1" && idade>=0 && idade<=1) ok=true;
         if(f==="2-5" && idade>=2 && idade<=5) ok=true;
         if(f==="6-10" && idade>=6 && idade<=10) ok=true;
         if(f==="11+" && idade>=11) ok=true;
       });
       if(!ok) incluir=false;
     }
     if(servSel.length && (!c.servicos || !c.servicos.some(s=>servSel.includes(s)))) incluir=false;
     if(prodSel.length && (!c.produtos || !c.produtos.some(p=>prodSel.includes(p)))) incluir=false;
     return incluir;
   });
   atualizarKPIs(filtrados);
 });
});

// Modal salvar alterações
function salvarAlteracoes(){
 if(!clienteAtual) return;
 const docRef=db.collection("clientes").doc(clienteAtual.id);
 const dados={
   nome: document.getElementById('modalNome').value,
   email: document.getElementById('modalEmail').value,
   telefone: document.getElementById('modalTelefone').value,
   cpf: document.getElementById('modalCPF').value,
   status: document.getElementById('modalStatus').value
 };
 docRef.update(dados).then(()=>{
   document.getElementById('mensagemModal').textContent="Alterações salvas com sucesso!";
   setTimeout(()=>fecharModal(),1500);
 }).catch(err=>{
   document.getElementById('mensagemModal').textContent="Erro ao salvar: "+err.message;
 });
}

// Exportar CSV
document.getElementById('btnExportar').addEventListener('click',()=>{
 db.collection("clientes").get().then(snapshot=>{
   let csv="Nome,E-mail,Telefone,CPF,Status\n";
   snapshot.forEach(doc=>{
     const c=doc.data();
     csv+=`${c.nome},${c.email},${c.telefone},${c.cpf||''},${c.status}\n`;
   });
   const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
   const link = document.createElement("a");
   link.href = URL.createObjectURL(blob);
   link.download = "clientes.csv";
   link.click();
 });
});
</script>
</body>
</html>
