<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Clientes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h1 { margin-bottom: 20px; }
    .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .kpi { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; }
    .kpi h2 { margin: 0; font-size: 24px; color: #007bff; }
    .kpi p { margin: 5px 0 0; color: #555; }
    button { padding: 10px 15px; border: none; border-radius: 6px; background: #007bff; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    th { background: #007bff; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #modalContent { background: #fff; padding: 20px; border-radius: 8px; width: 400px; }
    .modal-actions { display:flex; justify-content: space-between; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Gestão de Clientes</h1>

  <div class="kpi-container">
    <div class="kpi"><h2 id="totalClientes">0</h2><p>Total Clientes</p></div>
    <div class="kpi"><h2 id="novosMes">0</h2><p>Novos no Mês</p></div>
    <div class="kpi"><h2 id="fidelizados">0</h2><p>Fidelizados</p></div>
    <div class="kpi"><h2 id="vip">0</h2><p>VIP</p></div>
    <div class="kpi"><h2 id="aniversarios">0</h2><p>Aniversários 30d</p></div>
  </div>

  <button onclick="abrirCadastro()"><i class="fa fa-plus"></i> Cadastrar Cliente</button>
  <button onclick="exportarCSV()"><i class="fa fa-file-csv"></i> Exportar CSV</button>

  <table>
    <thead>
      <tr>
        <th>Nome</th><th>Telefone</th><th>Status</th><th>Cadastro</th>
      </tr>
    </thead>
    <tbody id="listaClientes"></tbody>
  </table>

  <!-- Modal Cadastro/Edição -->
  <div id="modal">
    <div id="modalContent">
      <h2 id="modalTitle">Cadastrar Cliente</h2>
      <input type="hidden" id="clienteId" />
      <label>Nome</label><br>
      <input type="text" id="nome" style="width:100%"><br>
      <label>Telefone</label><br>
      <input type="text" id="telefone" style="width:100%"><br>
      <label>Status</label><br>
      <select id="status" style="width:100%">
        <option value="Novo">Novo</option>
        <option value="Fidelizado">Fidelizado</option>
        <option value="VIP">VIP</option>
      </select><br>
      <label>Aniversário</label><br>
      <input type="date" id="aniversario" style="width:100%"><br>
      <p id="infoCadastro"></p>
      <div class="modal-actions">
        <button onclick="salvarCliente()">Salvar</button>
        <button style="background:#dc3545" onclick="excluirCliente()">Excluir</button>
        <button style="background:#6c757d" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
};
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const lista = document.getElementById("listaClientes");
    let clientesCache = [];

    function abrirCadastro(){
      document.getElementById("clienteId").value = "";
      document.getElementById("nome").value = "";
      document.getElementById("telefone").value = "";
      document.getElementById("status").value = "Novo";
      document.getElementById("aniversario").value = "";
      document.getElementById("infoCadastro").innerText = "";
      document.getElementById("modalTitle").innerText = "Cadastrar Cliente";
      document.getElementById("modal").style.display="flex";
    }

    function abrirEdicao(cliente){
      document.getElementById("clienteId").value = cliente.id;
      document.getElementById("nome").value = cliente.nome;
      document.getElementById("telefone").value = cliente.telefone;
      document.getElementById("status").value = cliente.status || "Novo";
      document.getElementById("aniversario").value = cliente.aniversario || "";
      let cadastro = cliente.cadastro ? formatarData(cliente.cadastro) : "";
      document.getElementById("infoCadastro").innerText = cadastro ? `Cadastrado em: ${cadastro}` : "";
      document.getElementById("modalTitle").innerText = "Editar Cliente";
      document.getElementById("modal").style.display="flex";
    }

    function fecharModal(){ document.getElementById("modal").style.display="none"; }

    async function salvarCliente(){
      const id = document.getElementById("clienteId").value;
      const nome = document.getElementById("nome").value;
      const telefone = document.getElementById("telefone").value;
      const status = document.getElementById("status").value;
      const aniversario = document.getElementById("aniversario").value;
      if(!nome) return alert("Nome obrigatório");

      if(id){
        await db.collection("clientes").doc(id).update({nome, telefone, status, aniversario});
      } else {
        await db.collection("clientes").add({
          nome, telefone, status, aniversario,
          cadastro: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      fecharModal();
    }

    async function excluirCliente(){
      const id = document.getElementById("clienteId").value;
      if(!id) return fecharModal();
      if(confirm("Deseja realmente excluir este cliente?")){
        await db.collection("clientes").doc(id).delete();
        fecharModal();
      }
    }

    function formatarData(valor){
      if(!valor) return "";
      let d;
      if(valor.toDate) d = valor.toDate();
      else d = new Date(valor);
      return d.toLocaleString();
    }

    function atualizarKPIs(clientes){
      document.getElementById("totalClientes").innerText = clientes.length;
      const agora = new Date();
      const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
      const novos = clientes.filter(c=> c.cadastro && (c.cadastro.toDate ? c.cadastro.toDate() : new Date(c.cadastro)) >= inicioMes);
      document.getElementById("novosMes").innerText = novos.length;
      document.getElementById("fidelizados").innerText = clientes.filter(c=>c.status==="Fidelizado").length;
      document.getElementById("vip").innerText = clientes.filter(c=>c.status==="VIP").length;
      const limite = new Date(); limite.setDate(limite.getDate()+30);
      const anivers = clientes.filter(c=> c.aniversario && new Date(c.aniversario) >= agora && new Date(c.aniversario) <= limite);
      document.getElementById("aniversarios").innerText = anivers.length;
    }

    function renderTabela(){
      lista.innerHTML = "";
      clientesCache.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.nome}</td><td>${c.telefone||""}</td><td>${c.status||""}</td><td>${formatarData(c.cadastro)}</td>`;
        tr.onclick = ()=>abrirEdicao(c);
        lista.appendChild(tr);
      });
    }

    function exportarCSV(){
      let csv = "Nome,Telefone,Status,Cadastro\n";
      clientesCache.forEach(c=>{
        csv += `${c.nome},${c.telefone||""},${c.status||""},${formatarData(c.cadastro)}\n`;
      });
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="clientes.csv"; a.click();
    }

    db.collection("clientes").onSnapshot(snap=>{
      clientesCache = snap.docs.map(d=>({id:d.id,...d.data()}));
      atualizarKPIs(clientesCache);
      renderTabela();
    });
  </script>
</body>
</html>
