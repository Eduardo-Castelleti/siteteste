<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Clientes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {background:#f4f6f9; padding:20px;}
h1 {color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.novos {background:#1abc9c;}
.card.fidelizados {background:#27ae60;}
.card.vip {background:#8e44ad;}
.card.alerta {background:#e74c3c;}
.graphs {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-top:30px;}
canvas {background:#fff; border-radius:10px; padding:10px;}
/* Modal */
#modalCadastro, #modalConsulta {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
.modalContent {background:#fff; padding:20px; border-radius:10px; max-width:400px; width:100%; position:relative;}
.closeModal {position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;}
.modalContent form input {width:100%; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modalContent form button {margin-top:15px; padding:10px 20px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
.modalContent form button:hover {background:#2ecc71;}
.modalContent p {margin-top:10px; font-weight:500;}
</style>
</head>
<body>

<h1>Clientes
  <button id="btnAbrirCadastro">Cadastrar Clientes</button>
  <button id="btnAbrirConsulta">Consultar Cliente</button>
</h1>

<div class="cards">
  <div class="card total"><h3>Total de Clientes</h3><p id="totalClientes">0</p></div>
  <div class="card novos"><h3>Novos no Mês</h3><p id="clientesNovos">0</p></div>
  <div class="card fidelizados"><h3>Fidelizados</h3><p id="clientesFidelizados">0</p></div>
  <div class="card vip"><h3>VIP</h3><p id="clientesVIP">0</p></div>
  <div class="card alerta"><h3>Aniversário Próximo</h3><p id="clientesAniversario">0</p></div>
</div>

<div class="graphs">
  <canvas id="graficoTicketMedio"></canvas>
  <canvas id="graficoFaixaGasto"></canvas>
  <canvas id="graficoFrequencia"></canvas>
  <canvas id="graficoIdade"></canvas>
</div>

<!-- Modal Cadastro -->
<div id="modalCadastro">
  <div class="modalContent">
    <span class="closeModal" id="fecharCadastro">&times;</span>
    <h2>Cadastrar Cliente</h2>
    <form id="formCadastro">
      <label for="nomeCliente">Nome *</label>
      <input type="text" id="nomeCliente" required>
      <label for="telefoneCliente">Telefone *</label>
      <input type="text" id="telefoneCliente" required>
      <label for="emailCliente">E-mail *</label>
      <input type="email" id="emailCliente" required>
      <label for="cpfCliente">CPF (opcional)</label>
      <input type="text" id="cpfCliente">
      <label for="nascimentoCliente">Data de Nascimento</label>
      <input type="date" id="nascimentoCliente">
      <button type="submit">Cadastrar</button>
      <p id="mensagemCadastro"></p>
    </form>
  </div>
</div>

<!-- Modal Consulta -->
<div id="modalConsulta">
  <div class="modalContent">
    <span class="closeModal" id="fecharConsulta">&times;</span>
    <h2>Consultar Cliente</h2>
    <form id="formConsulta">
      <label for="emailConsulta">Digite o e-mail do cliente</label>
      <input type="email" id="emailConsulta" required>
      <button type="submit">Buscar</button>
      <p id="mensagemConsulta"></p>
    </form>
    <div id="resultadoConsulta" style="display:none; margin-top:15px;">
      <p><strong>Nome:</strong> <span id="cNome"></span></p>
      <p><strong>Telefone:</strong> <span id="cTelefone"></span></p>
      <p><strong>CPF:</strong> <span id="cCPF"></span></p>
      <p><strong>Data Nascimento:</strong> <span id="cNascimento"></span></p>
      <p><strong>Status:</strong> <span id="cStatus"></span></p>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Função idade
function calcularIdade(nascimento){
    if(!nascimento) return "";
    const hoje = new Date();
    const dataNasc = new Date(nascimento);
    let idade = hoje.getFullYear() - dataNasc.getFullYear();
    const m = hoje.getMonth() - dataNasc.getMonth();
    if(m<0 || (m===0 && hoje.getDate()<dataNasc.getDate())) idade--;
    return idade;
}

// Modal
const modalCadastro = document.getElementById("modalCadastro");
const modalConsulta = document.getElementById("modalConsulta");
document.getElementById("btnAbrirCadastro").onclick = ()=>modalCadastro.style.display="flex";
document.getElementById("fecharCadastro").onclick = ()=>modalCadastro.style.display="none";
document.getElementById("btnAbrirConsulta").onclick = ()=>modalConsulta.style.display="flex";
document.getElementById("fecharConsulta").onclick = ()=>modalConsulta.style.display="none";

// Cadastro cliente
document.getElementById('formCadastro').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nome = document.getElementById('nomeCliente').value.trim();
    const telefone = document.getElementById('telefoneCliente').value.trim();
    const email = document.getElementById('emailCliente').value.trim();
    const cpf = document.getElementById('cpfCliente').value.trim();
    const nascimento = document.getElementById('nascimentoCliente').value;
    const msg = document.getElementById('mensagemCadastro');
    msg.textContent="";
    try{
        // Cria login no Firebase Auth
        const senhaPadrao = Math.random().toString(36).slice(-8);
        const user = await auth.createUserWithEmailAndPassword(email, senhaPadrao);
        await auth.sendPasswordResetEmail(email);
        // Cria registro Firestore
        await db.collection("clientes").doc(user.user.uid).set({
            nome, telefone, email, cpf, nascimento, status:"ativo", cadastro:new Date(), vip:false, fidelizado:false
        });
        msg.style.color="green";
        msg.textContent="Cliente cadastrado com sucesso! E-mail enviado.";
        document.getElementById('formCadastro').reset();
        setTimeout(()=>modalCadastro.style.display="none",1500);
    }catch(err){
        msg.style.color="red";
        msg.textContent="Erro: "+err.message;
    }
});

// Consulta cliente
document.getElementById('formConsulta').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('emailConsulta').value.trim();
    const msg = document.getElementById('mensagemConsulta');
    const res = document.getElementById('resultadoConsulta');
    res.style.display="none";
    msg.textContent="";
    try{
        const query = await db.collection("clientes").where("email","==",email).get();
        if(query.empty) return msg.textContent="Cliente não encontrado";
        const c = query.docs[0].data();
        document.getElementById('cNome').textContent = c.nome;
        document.getElementById('cTelefone').textContent = c.telefone;
        document.getElementById('cCPF').textContent = c.cpf||'';
        document.getElementById('cNascimento').textContent = c.nascimento||'';
        document.getElementById('cStatus').textContent = c.status;
        res.style.display="block";
    }catch(err){
        msg.textContent="Erro: "+err.message;
    }
});

// Atualizar cards e gráficos
function atualizarCards(snapshot){
    let total=0, novos=0, fidelizados=0, vip=0, aniversarios=0;
    const hoje = new Date();
    snapshot.forEach(doc=>{
        const c = doc.data();
        if(c.status==="ativo") total++;
        if(c.vip) vip++;
        if(c.fidelizado) fidelizados++;
        if(new Date(c.cadastro) >= new Date(hoje.getFullYear(), hoje.getMonth()-1, hoje.getDate())) novos++;
        if(c.nascimento){
            const nasc = new Date(c.nascimento);
            const prox = new Date(hoje.getFullYear(), nasc.getMonth(), nasc.getDate());
            const diff = (prox-hoje)/(1000*60*60*24);
            if(diff>=0 && diff<=7) aniversarios++;
        }
    });
    document.getElementById('totalClientes').textContent=total;
    document.getElementById('clientesNovos').textContent=novos;
    document.getElementById('clientesFidelizados').textContent=fidelizados;
    document.getElementById('clientesVIP').textContent=vip;
    document.getElementById('clientesAniversario').textContent=aniversarios;
    // Gráficos podem ser atualizados aqui, conforme necessidade
}
db.collection("clientes").onSnapshot(snapshot=>atualizarCards(snapshot.docs));
</script>
</body>
</html>
