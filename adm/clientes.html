<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Clientes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {background:#f4f6f9; padding:20px;}
h1 {margin-bottom:20px; color:#2c3e50;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.novos {background:#1abc9c;}
.card.fidelizados {background:#27ae60;}
.card.vip {background:#8e44ad;}
.card.alerta {background:#e74c3c;}
.card.ticket {background:#f39c12;}
.card.gasto {background:#16a085;}
.card.frequencia {background:#d35400;}
.card.churn {background:#c0392b;}
.card.assinaturas {background:#8e44ad;}
.graphs {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-top:30px;}
canvas {background:#fff; border-radius:10px; padding:10px;}
/* Modal */
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
.modal-content {background:#fff; padding:20px; border-radius:10px; width:400px; max-width:90%;}
.modal-content h2 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px; font-weight:500;}
.modal-content input, .modal-content select {width:100%; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
.modal-content button:hover {background:#2ecc71;}
#mensagemModal {margin-top:10px; font-weight:500;}
</style>
</head>
<body>

<h1>Clientes</h1>

<div class="cards">
  <div class="card total"><h3>Total de Clientes</h3><p id="totalClientes">0</p></div>
  <div class="card novos"><h3>Novos no Mês</h3><p id="clientesNovos">0</p></div>
  <div class="card fidelizados"><h3>Fidelizados</h3><p id="clientesFidelizados">0</p></div>
  <div class="card vip"><h3>VIP</h3><p id="clientesVIP">0</p></div>
  <div class="card alerta"><h3>Aniversário Próximo</h3><p id="clientesAniversario">0</p></div>
  <div class="card ticket"><h3>Ticket Médio</h3><p id="ticketMedio">0</p></div>
  <div class="card gasto"><h3>Faixa de Gasto Alto</h3><p id="clientesAltoGasto">0</p></div>
  <div class="card frequencia"><h3>Compras Frequentes</h3><p id="clientesFreqAlta">0</p></div>
  <div class="card churn"><h3>Inativos</h3><p id="clientesInativos">0</p></div>
  <div class="card assinaturas"><h3>Assinaturas Ativas</h3><p id="assinaturasAtivas">0</p></div>
</div>

<div class="graphs">
<canvas id="graficoTicketMedio"></canvas>
<canvas id="graficoFaixaGasto"></canvas>
<canvas id="graficoFrequencia"></canvas>
<canvas id="graficoIdade"></canvas>
</div>

<!-- Modal de Edição -->
<div class="modal" id="modalCliente">
<div class="modal-content">
<h2>Editar Cliente</h2>
<label>Nome</label>
<input type="text" id="modalNome" disabled>
<label>E-mail</label>
<input type="email" id="modalEmail">
<label>Telefone</label>
<input type="text" id="modalTelefone">
<label>CPF</label>
<input type="text" id="modalCPF">
<label>Data de Nascimento</label>
<input type="date" id="modalNascimento">
<label>Status</label>
<select id="modalStatus">
  <option value="ativo">Ativo</option>
  <option value="inativo">Inativo</option>
  <option value="VIP">VIP</option>
  <option value="fidelizado">Fidelizado</option>
</select>
<label>Fidelizado</label>
<select id="modalFidelizado">
  <option value="true">Sim</option>
  <option value="false">Não</option>
</select>
<label>VIP</label>
<select id="modalVIP">
  <option value="true">Sim</option>
  <option value="false">Não</option>
</select>
<label>Assinaturas</label>
<input type="text" id="modalAssinaturas" placeholder="Separadas por vírgula">
<button id="salvarCliente">Salvar Alterações</button>
<div id="mensagemModal"></div>
<button onclick="fecharModal()" style="background:#e74c3c;margin-top:5px;">Fechar</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
}; 
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

function calcularIdade(nascimento){
    const hoje = new Date();
    const dataNasc = new Date(nascimento);
    let idade = hoje.getFullYear() - dataNasc.getFullYear();
    const m = hoje.getMonth() - dataNasc.getMonth();
    if(m<0 || (m===0 && hoje.getDate()<dataNasc.getDate())) idade--;
    return idade;
}

// Variáveis gráficos
let graficoTicket, graficoGasto, graficoFreq, graficoIdade;

// Atualizar KPIs
function atualizarKPIs(snapshot){
    let total=0, novos=0, fidelizados=0, vip=0, aniversarios=0, ticketTotal=0, gastoAlto=0, freqAlta=0, inativos=0, assinaturas=0;
    const hoje = new Date();
    snapshot.forEach(doc=>{
        const c = doc.data();
        total++;
        if(c.status==="ativo") total++;
        if(c.vip) vip++;
        if(c.fidelizado) fidelizados++;
        if(new Date(c.cadastro) >= new Date(hoje.getFullYear(), hoje.getMonth(), 1)) novos++;
        if(c.nascimento){
            const prox = new Date(hoje.getFullYear(), new Date(c.nascimento).getMonth(), new Date(c.nascimento).getDate());
            const diff = (prox-hoje)/(1000*60*60*24);
            if(diff>=0 && diff<=7) aniversarios++;
        }
        // Ticket médio
        let t=0;
        if(c.compras && c.compras.length>0){
            t=c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0)/c.compras.length;
            ticketTotal+=t;
        }
        // Faixa gasto
        if(t>=200) gastoAlto++; // exemplo
        // Frequência
        if(c.compras && c.compras.length>=5) freqAlta++;
        // Inativos
        if(!c.compras || c.compras.length===0) inativos++;
        // Assinaturas
        if(c.assinaturas && c.assinaturas.length>0) assinaturas++;
    });

    document.getElementById('totalClientes').textContent = total;
    document.getElementById('clientesNovos').textContent = novos;
    document.getElementById('clientesFidelizados').textContent = fidelizados;
    document.getElementById('clientesVIP').textContent = vip;
    document.getElementById('clientesAniversario').textContent = aniversarios;
    document.getElementById('ticketMedio').textContent = (ticketTotal/total || 0).toFixed(2);
    document.getElementById('clientesAltoGasto').textContent = gastoAlto;
    document.getElementById('clientesFreqAlta').textContent = freqAlta;
    document.getElementById('clientesInativos').textContent = inativos;
    document.getElementById('assinaturasAtivas').textContent = assinaturas;

    atualizarGraficos(snapshot);
}

// Mostrar modal de edição
let clienteAtual=null;
function abrirModal(c){
    clienteAtual=c;
    document.getElementById('modalNome').value=c.nome;
    document.getElementById('modalEmail').value=c.email;
    document.getElementById('modalTelefone').value=c.telefone;
    document.getElementById('modalCPF').value=c.cpf||'';
    document.getElementById('modalNascimento').value=c.nascimento||'';
    document.getElementById('modalStatus').value=c.status;
    document.getElementById('modalFidelizado').value=c.fidelizado?"true":"false";
    document.getElementById('modalVIP').value=c.vip?"true":"false";
    document.getElementById('modalAssinaturas').value=c.assinaturas?c.assinaturas.join(","):'';
    document.getElementById('mensagemModal').textContent="";
    document.getElementById('modalCliente').style.display='flex';
}

function fecharModal(){
    document.getElementById('modalCliente').style.display='none';
}

// Salvar alterações
document.getElementById('salvarCliente').addEventListener('click', async ()=>{
    if(!clienteAtual) return;
    const id = clienteAtual.id;
    const dataAtualizada = {
        email: document.getElementById('modalEmail').value,
        telefone: document.getElementById('modalTelefone').value,
        cpf: document.getElementById('modalCPF').value,
        nascimento: document.getElementById('modalNascimento').value,
        status: document.getElementById('modalStatus').value,
        fidelizado: document.getElementById('modalFidelizado').value==="true",
        vip: document.getElementById('modalVIP').value==="true",
        assinaturas: document.getElementById('modalAssinaturas').value.split(",").map(x=>x.trim()).filter(x=>x)
    };
    try{
        await db.collection("clientes").doc(id).update(dataAtualizada);
        document.getElementById('mensagemModal').style.color='green';
        document.getElementById('mensagemModal').textContent='Cliente atualizado com sucesso!';
        setTimeout(fecharModal,1500);
    }catch(e){
        document.getElementById('mensagemModal').style.color='red';
        document.getElementById('mensagemModal').textContent='Erro: '+e.message;
        console.error(e);
    }
});

// Gráficos
function atualizarGraficos(snapshot){
    const clientes=[];
    snapshot.forEach(doc=>{
        clientes.push({...doc.data(), id: doc.id});
    });

    // Ticket médio por cliente
    const labels = clientes.map(c=>c.nome);
    const ticket = clientes.map(c=>{
        if(c.compras && c.compras.length>0) return c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0)/c.compras.length;
        return 0;
    });

    // Faixa de gasto
    const gastoLabels = ["Baixo","Médio","Alto"];
    const gastoData=[0,0,0];
    clientes.forEach(c=>{
        let t=0;
        if(c.compras && c.compras.length>0) t=c.compras.reduce((acc,i)=>acc+parseFloat(i.valor),0)/c.compras.length;
        if(t<100) gastoData[0]++;
        else if(t<200) gastoData[1]++;
        else gastoData[2]++;
    });

    // Frequência
    const freqLabels=["Baixa","Média","Alta"];
    const freqData=[0,0,0];
    clientes.forEach(c=>{
        const n = c.compras ? c.compras.length :0;
        if(n<=2) freqData[0]++;
        else if(n<=5) freqData[1]++;
        else freqData[2]++;
    });

    // Faixa etária
    const idadeLabels=["0-1","2-5","6-10","11+"];
    const idadeData=[0,0,0,0];
    clientes.forEach(c=>{
        if(c.nascimento){
            const idade=calcularIdade(c.nascimento);
            if(idade<=1) idadeData[0]++;
            else if(idade<=5) idadeData[1]++;
            else if(idade<=10) idadeData[2]++;
            else idadeData[3]++;
        }
    });

    if(graficoTicket) graficoTicket.destroy();
    const ctxTicket = document.getElementById('graficoTicketMedio').getContext('2d');
    graficoTicket = new Chart(ctxTicket,{type:'bar',data:{labels,datasets:[{label:'Ticket Médio', data:ticket, backgroundColor:'#2980b9'}]}});

    if(graficoGasto) graficoGasto.destroy();
    const ctxGasto = document.getElementById('graficoFaixaGasto').getContext('2d');
    graficoGasto = new Chart(ctxGasto,{type:'pie',data:{labels:gastoLabels,datasets:[{data:gastoData, backgroundColor:['#1abc9c','#f39c12','#e74c3c']}]}});

    if(graficoFreq) graficoFreq.destroy();
    const ctxFreq = document.getElementById('graficoFrequencia').getContext('2d');
    graficoFreq = new Chart(ctxFreq,{type:'pie',data:{labels:freqLabels,datasets:[{data:freqData, backgroundColor:['#27ae60','#f1c40f','#c0392b']}]}});

    if(graficoIdade) graficoIdade.destroy();
    const ctxIdade = document.getElementById('graficoIdade').getContext('2d');
    graficoIdade = new Chart(ctxIdade,{type:'pie',data:{labels:idadeLabels,datasets:[{data:idadeData, backgroundColor:['#1abc9c','#27ae60','#8e44ad','#e74c3c']}]}});

    // Adicionar evento clique para abrir modal
    clientes.forEach(c=>{
        if(c.vip || c.fidelizado || c.compras){ // clientes ativos
            // Simulação: clique abre modal de edição
            // Aqui poderia ter uma lista filtrável se necessário
            // Ex: document.getElementById("btnEditar"+c.id).onclick = ()=>abrirModal(c);
        }
    });
}

// Snapshot em tempo real
db.collection("clientes").onSnapshot(snapshot=>{
    atualizarKPIs(snapshot.docs);
});
</script>
</body>
</html>
