<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Pet - Parceiros</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.collection = collection;
  window.addDoc = addDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
</script>

<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}

/* Sidebar */
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:red; color:white; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:auto;}

/* Main */
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}

/* Cards */
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.ativos {background:#1abc9c;}
.card.inativos {background:#e74c3c;}

/* Search */
.search-bar {margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; flex-wrap:wrap;}
.search-bar input, .search-bar select {padding:10px; border-radius:5px; border:1px solid #ccc;}
.search-bar button {padding:10px 15px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.search-bar button:hover {background:#3498db;}

/* Graphs */
.graphs {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-top:30px;}
canvas {background:#fff; border-radius:10px; padding:10px;}

/* Form */
.form-container {background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.form-container input, .form-container select, .form-container button {margin-bottom:10px;}
.form-container button {background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
.form-container button:hover {background:#2ecc71;}
</style>
</head>

<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>Admin Pet</h2>
  <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
  <a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
  <a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
  <a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
  <a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
  <a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
  <a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
  <a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
  <a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
  <a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
  <a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
  <a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
  <a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<!-- Main content -->
<div class="main-content">
  <h1>Parceiros</h1>

  <!-- KPIs -->
  <div class="cards">
    <div class="card total"><h3 id="total-parceiros">0</h3><p>Total</p></div>
    <div class="card ativos"><h3 id="ativos-parceiros">0</h3><p>Ativos</p></div>
    <div class="card inativos"><h3 id="inativos-parceiros">0</h3><p>Inativos</p></div>
  </div>

  <!-- Pesquisa -->
  <div class="form-container">
    <h3>Consultar Parceiro</h3>
    <input type="text" id="pesquisa-parceiro" placeholder="Nome ou CNPJ">
    <button onclick="consultarParceiro()">Buscar</button>
  </div>

  <!-- Cadastro / Alteração -->
  <div class="form-container">
    <h3>Adicionar / Alterar Parceiro</h3>
    <input type="text" id="cnpj" placeholder="CNPJ / CPF">
    <input type="text" id="nome_empresa" placeholder="Nome da Empresa">
    <input type="text" id="telefone_empresa" placeholder="Telefone da Empresa">
    <input type="email" id="email_empresa" placeholder="Email da Empresa">
    <input type="text" id="nome_responsavel" placeholder="Nome do Responsável">
    <input type="text" id="telefone_responsavel" placeholder="Telefone do Responsável">
    <input type="email" id="email_responsavel" placeholder="Email do Responsável">
    <input type="text" id="cep" placeholder="CEP">
    <input type="text" id="rua" placeholder="Rua">
    <input type="text" id="bairro" placeholder="Bairro">
    <input type="text" id="cidade" placeholder="Cidade">
    <input type="text" id="estado" placeholder="Estado">
    <select id="tipo">
      <option value="Banho/Tosa">Banho/Tosa</option>
      <option value="Creche">Creche</option>
      <option value="Clínica">Clínica</option>
      <option value="Outro">Outro</option>
    </select>
    <select id="status">
      <option value="Ativo">Ativo</option>
      <option value="Inativo">Inativo</option>
    </select>
    <button onclick="salvarParceiro()">Salvar Parceiro</button>
  </div>

  <!-- Gráficos -->
  <div class="graphs">
    <div><h3>Parceiros por Tipo</h3><canvas id="graficoTipo"></canvas></div>
    <div><h3>Novos Parceiros por Mês</h3><canvas id="graficoMes"></canvas></div>
  </div>
</div>

<script>
  const db = window.db;
  const parceirosCollection = window.collection(db, "parceiros");

  // CEP responsivo
  document.getElementById('cep').addEventListener('blur', () => {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if(cep.length === 8){
      fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(dados => {
          if (!dados.erro) {
            document.getElementById('rua').value = dados.logradouro;
            document.getElementById('bairro').value = dados.bairro;
            document.getElementById('cidade').value = dados.localidade;
            document.getElementById('estado').value = dados.uf;
          } else {
            alert('CEP não encontrado!');
          }
        });
    }
  });

  async function salvarParceiro(){
    const parceiro = {
      cnpj: document.getElementById('cnpj').value,
      nome_empresa: document.getElementById('nome_empresa').value,
      telefone_empresa: document.getElementById('telefone_empresa').value,
      email_empresa: document.getElementById('email_empresa').value,
      nome_responsavel: document.getElementById('nome_responsavel').value,
      telefone_responsavel: document.getElementById('telefone_responsavel').value,
      email_responsavel: document.getElementById('email_responsavel').value,
      endereco: `${document.getElementById('rua').value}, ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}`,
      tipo: document.getElementById('tipo').value,
      status: document.getElementById('status').value,
      created_at: new Date().toISOString()
    };
    try {
      await window.addDoc(parceirosCollection, parceiro);
      alert('Parceiro salvo com sucesso!');
      carregarKpis();
      carregarGraficos();
    } catch (e) {
      console.error(e);
      alert('Erro ao salvar parceiro!');
    }
  }

  async function consultarParceiro(){
    const pesquisa = document.getElementById('pesquisa-parceiro').value.toLowerCase();
    const snapshot = await window.getDocs(parceirosCollection);
    let encontrado = false;
    snapshot.forEach(doc => {
      const data = doc.data();
      if(data.nome_empresa.toLowerCase() === pesquisa || data.cnpj === pesquisa){
        encontrado = true;
        document.getElementById('cnpj').value = data.cnpj;
        document.getElementById('nome_empresa').value = data.nome_empresa;
        document.getElementById('telefone_empresa').value = data.telefone_empresa;
        document.getElementById('email_empresa').value = data.email_empresa;
        document.getElementById('nome_responsavel').value = data.nome_responsavel;
        document.getElementById('telefone_responsavel').value = data.telefone_responsavel;
        document.getElementById('email_responsavel').value = data.email_responsavel;
        const endParts = data.endereco.split(',');
        document.getElementById('rua').value = endParts[0] || '';
        document.getElementById('bairro').value = endParts[1] || '';
        document.getElementById('cidade').value = endParts[2]?.split('-')[0].trim() || '';
        document.getElementById('estado').value = endParts[2]?.split('-')[1]?.trim() || '';
        document.getElementById('tipo').value = data.tipo;
        document.getElementById('status').value = data.status;
      }
    });
    if(!encontrado) alert('Parceiro não encontrado!');
  }

  async function carregarKpis(){
    const snapshot = await window.getDocs(parceirosCollection);
    let total=0, ativos=0, inativos=0;
    snapshot.forEach(doc => {
      total++;
      const data = doc.data();
      if(data.status === "Ativo") ativos++;
      else inativos++;
    });
    document.getElementById('total-parceiros').innerText = total;
    document.getElementById('ativos-parceiros').innerText = ativos;
    document.getElementById('inativos-parceiros').innerText = inativos;
  }

  async function carregarGraficos(){
    const snapshot = await window.getDocs(parceirosCollection);
    const tipos = {};
    const meses = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      tipos[data.tipo] = (tipos[data.tipo] || 0) + 1;
      const mes = new Date(data.created_at).toLocaleString('pt-BR', { month:'short', year:'numeric'});
      meses[mes] = (meses[mes] || 0) +1;
    });

    const ctx1 = document.getElementById('graficoTipo').getContext('2d');
    new Chart(ctx1, {
      type: 'pie',
      data: { labels: Object.keys(tipos), datasets:[{data: Object.values(tipos), backgroundColor:['#1f77b4','#ff7f0e','#2ca02c','#d62728']}] }
    });

    const ctx2 = document.getElementById('graficoMes').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: { labels:Object.keys(meses), datasets:[{label:'Novos Parceiros', data:Object.values(meses), backgroundColor:'#1f77b4'}] },
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });
  }

  carregarKpis();
  carregarGraficos();
</script>

</body>
</html>
