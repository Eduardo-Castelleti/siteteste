<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Pet - Parceiros</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.collection = collection;
  window.addDoc = addDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
</script>

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0;}
  .sidebar { width:220px; background:#1f1f1f; color:#fff; position:fixed; height:100%; padding-top:20px;}
  .sidebar h2 { text-align:center; margin-bottom:30px;}
  .sidebar a { display:block; padding:10px 20px; color:#fff; text-decoration:none;}
  .sidebar a:hover { background:#333;}
  .main { margin-left:220px; padding:20px;}
  .card { background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; display:inline-block; width:23%; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  input, select { width:100%; padding:8px; margin:5px 0 10px; border-radius:5px; border:1px solid #ccc;}
  button { padding:10px 20px; border:none; border-radius:5px; background:#1f1f1f; color:#fff; cursor:pointer;}
  button:hover { background:#333;}
  .form-container { background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .chart-container { background:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
</style>
</head>

<body>

<div class="sidebar">
  <h2>Admin Pet</h2>
  <a href="index.html"><i class="fa fa-home"></i> Dashboard</a>
  <a href="clientes.html"><i class="fa fa-users"></i> Clientes</a>
  <a href="parceiros.html"><i class="fa fa-handshake"></i> Parceiros</a>
  <a href="produtos.html"><i class="fa fa-box"></i> Produtos</a>
</div>

<div class="main">
  <h1>Parceiros</h1>

  <!-- KPIs -->
  <div class="cards">
    <div class="card"><h3 id="total-parceiros">0</h3><p>Total</p></div>
    <div class="card"><h3 id="ativos-parceiros">0</h3><p>Ativos</p></div>
    <div class="card"><h3 id="inativos-parceiros">0</h3><p>Inativos</p></div>
  </div>

  <!-- Pesquisa -->
  <div class="form-container">
    <h3>Consultar Parceiro</h3>
    <input type="text" id="pesquisa-parceiro" placeholder="Nome ou CNPJ">
    <button onclick="consultarParceiro()">Buscar</button>
  </div>

  <!-- Cadastro/Alteração -->
  <div class="form-container">
    <h3>Adicionar / Alterar Parceiro</h3>
    <input type="text" id="cnpj" placeholder="CNPJ / CPF">
    <input type="text" id="nome_empresa" placeholder="Nome da Empresa">
    <input type="text" id="telefone_empresa" placeholder="Telefone da Empresa">
    <input type="email" id="email_empresa" placeholder="Email da Empresa">
    <input type="text" id="nome_responsavel" placeholder="Nome do Responsável">
    <input type="text" id="telefone_responsavel" placeholder="Telefone do Responsável">
    <input type="email" id="email_responsavel" placeholder="Email do Responsável">
    <input type="text" id="cep" placeholder="CEP">
    <input type="text" id="rua" placeholder="Rua">
    <input type="text" id="bairro" placeholder="Bairro">
    <input type="text" id="cidade" placeholder="Cidade">
    <input type="text" id="estado" placeholder="Estado">
    <select id="tipo">
      <option value="Banho/Tosa">Banho/Tosa</option>
      <option value="Creche">Creche</option>
      <option value="Clínica">Clínica</option>
      <option value="Outro">Outro</option>
    </select>
    <select id="status">
      <option value="Ativo">Ativo</option>
      <option value="Inativo">Inativo</option>
    </select>
    <button onclick="salvarParceiro()">Salvar Parceiro</button>
  </div>

  <!-- Gráficos -->
  <div class="chart-container">
    <h3>Parceiros por Tipo</h3>
    <canvas id="graficoTipo"></canvas>
  </div>
  <div class="chart-container">
    <h3>Novos Parceiros por Mês</h3>
    <canvas id="graficoMes"></canvas>
  </div>
</div>

<script>
  const db = window.db;
  const parceirosCollection = window.collection(db, "parceiros");

  // CEP responsivo
  document.getElementById('cep').addEventListener('blur', () => {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if(cep.length === 8){
      fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(dados => {
          if (!dados.erro) {
            document.getElementById('rua').value = dados.logradouro;
            document.getElementById('bairro').value = dados.bairro;
            document.getElementById('cidade').value = dados.localidade;
            document.getElementById('estado').value = dados.uf;
          } else {
            alert('CEP não encontrado!');
          }
        });
    }
  });

  async function salvarParceiro(){
    const parceiro = {
      cnpj: document.getElementById('cnpj').value,
      nome_empresa: document.getElementById('nome_empresa').value,
      telefone_empresa: document.getElementById('telefone_empresa').value,
      email_empresa: document.getElementById('email_empresa').value,
      nome_responsavel: document.getElementById('nome_responsavel').value,
      telefone_responsavel: document.getElementById('telefone_responsavel').value,
      email_responsavel: document.getElementById('email_responsavel').value,
      endereco: `${document.getElementById('rua').value}, ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}`,
      tipo: document.getElementById('tipo').value,
      status: document.getElementById('status').value,
      created_at: new Date().toISOString()
    };
    try {
      await window.addDoc(parceirosCollection, parceiro);
      alert('Parceiro salvo com sucesso!');
      carregarKpis();
      carregarGraficos();
    } catch (e) {
      console.error(e);
      alert('Erro ao salvar parceiro!');
    }
  }

  async function consultarParceiro(){
    const pesquisa = document.getElementById('pesquisa-parceiro').value.toLowerCase();
    const snapshot = await window.getDocs(parceirosCollection);
    let encontrado = false;
    snapshot.forEach(doc => {
      const data = doc.data();
      if(data.nome_empresa.toLowerCase() === pesquisa || data.cnpj === pesquisa){
        encontrado = true;
        // Preenche formulário para edição
        document.getElementById('cnpj').value = data.cnpj;
        document.getElementById('nome_empresa').value = data.nome_empresa;
        document.getElementById('telefone_empresa').value = data.telefone_empresa;
        document.getElementById('email_empresa').value = data.email_empresa;
        document.getElementById('nome_responsavel').value = data.nome_responsavel;
        document.getElementById('telefone_responsavel').value = data.telefone_responsavel;
        document.getElementById('email_responsavel').value = data.email_responsavel;
        const endParts = data.endereco.split(',');
        document.getElementById('rua').value = endParts[0] || '';
        document.getElementById('bairro').value = endParts[1] || '';
        document.getElementById('cidade').value = endParts[2]?.split('-')[0].trim() || '';
        document.getElementById('estado').value = endParts[2]?.split('-')[1]?.trim() || '';
        document.getElementById('tipo').value = data.tipo;
        document.getElementById('status').value = data.status;
      }
    });
    if(!encontrado) alert('Parceiro não encontrado!');
  }

  // KPIs
  async function carregarKpis(){
    const snapshot = await window.getDocs(parceirosCollection);
    let total=0, ativos=0, inativos=0;
    snapshot.forEach(doc => {
      total++;
      const data = doc.data();
      if(data.status === "Ativo") ativos++;
      else inativos++;
    });
    document.getElementById('total-parceiros').innerText = total;
    document.getElementById('ativos-parceiros').innerText = ativos;
    document.getElementById('inativos-parceiros').innerText = inativos;
  }

  // Gráficos
  async function carregarGraficos(){
    const snapshot = await window.getDocs(parceirosCollection);
    const tipos = {};
    const meses = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      tipos[data.tipo] = (tipos[data.tipo] || 0) + 1;

      const mes = new Date(data.created_at).toLocaleString('pt-BR', { month:'short', year:'numeric'});
      meses[mes] = (meses[mes] || 0) +1;
    });

    // Tipo de parceiro
    const ctx1 = document.getElementById('graficoTipo').getContext('2d');
    new Chart(ctx1, {
      type: 'pie',
      data: {
        labels: Object.keys(tipos),
        datasets: [{
          data: Object.values(tipos),
          backgroundColor: ['#1f77b4','#ff7f0e','#2ca02c','#d62728']
        }]
      }
    });

    // Novos parceiros por mês
    const ctx2 = document.getElementById('graficoMes').getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: Object.keys(meses),
        datasets: [{
          label: 'Novos Parceiros',
          data: Object.values(meses),
          backgroundColor: '#1f77b4'
        }]
      },
      options: { responsive:true, plugins: { legend:{ display:false } } }
    });
  }

  // Inicializa KPIs e gráficos
  carregarKpis();
  carregarGraficos();
</script>

</body>
</html>
