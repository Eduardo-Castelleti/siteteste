<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:red; color:white; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.novos {background:#1abc9c;}
.card.faturamento {background:#27ae60;}
.card.vip {background:#8e44ad;}
.search-bar {margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; flex-wrap:wrap;}
.search-bar input, .search-bar select {padding:10px; border-radius:5px; border:1px solid #ccc;}
.search-bar button {padding:10px 15px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.search-bar button:hover {background:#3498db;}
.client-list {margin-top:20px; background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.client-list table {width:100%; border-collapse:collapse;}
.client-list table th, .client-list table td {padding:10px; border-bottom:1px solid #ddd; text-align:left;}
.client-list table tr:hover {background:#f0f0f0;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;}
.modal-content {background:#fff; padding:20px; border-radius:10px; width:400px; max-width:90%; position:relative;}
.modal-content h2 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px;}
.modal-content input, .modal-content select {width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer;}
.modal-content button:hover {background:#2ecc71;}
.modal-close {position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;}
#mensagemCadastro{margin-top:10px; font-weight:500;}
</style>
</head>
<body>

<div class="sidebar">
<h2>Admin Pet</h2>
<a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
<a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
<a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
<a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
<a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
<a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
<a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
</div>

<div class="main-content">
<h1>Parceiros <button id="btnAbrirCadastro">Cadastrar Parceiro</button></h1>

<div class="cards">
<div class="card total"><h3>Total de Parceiros</h3><p id="totalParceiros">0</p></div>
<div class="card novos"><h3>Novos no Mês</h3><p id="novosParceiros">0</p></div>
<div class="card faturamento"><h3>Maior Faturamento</h3><p id="parceiroTop">-</p></div>
<div class="card vip"><h3>VIP / Top Parceiros</h3><p id="vipParceiros">0</p></div>
</div>

<div class="search-bar">
<input type="text" id="buscaParceiro" placeholder="Pesquisar por nome, e-mail, telefone, CNPJ">
<select id="filtroStatus" multiple>
<option value="ativo">Ativo</option>
<option value="inativo">Inativo</option>
<option value="VIP">VIP</option>
</select>
<button id="btnBuscar"><i class="fas fa-search"></i> Buscar</button>
</div>

<div class="client-list" id="listaParceiros" style="display:none;">
<h3>Lista de Parceiros</h3>
<table id="tabelaParceiros">
<thead>
<tr>
<th>Nome</th><th>E-mail</th><th>Telefone</th><th>CNPJ</th><th>Status</th><th>Faturamento</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- Modal Cadastro / Edição -->
<div class="modal" id="modalCadastro">
<div class="modal-content">
<span class="modal-close" id="fecharModal">&times;</span>
<h2 id="modalTitle">Adicionar Parceiro</h2>
<form id="formCadastro">
<label for="nomeParceiro">Nome *</label>
<input type="text" id="nomeParceiro" required>
<label for="telefoneParceiro">Telefone *</label>
<input type="text" id="telefoneParceiro" required>
<label for="emailParceiro">E-mail *</label>
<input type="email" id="emailParceiro" required>
<label for="cnpjParceiro">CNPJ</label>
<input type="text" id="cnpjParceiro">
<label for="statusParceiro">Status</label>
<select id="statusParceiro">
<option value="ativo">Ativo</option>
<option value="inativo">Inativo</option>
<option value="VIP">VIP</option>
</select>
<button type="submit" id="btnSalvar">Salvar</button>
<p id="mensagemCadastro"></p>
</form>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let parceiroAtual = null;
const modal = document.getElementById("modalCadastro");

// Abrir cadastro
document.getElementById("btnAbrirCadastro").onclick = () => {
    modal.style.display = "flex";
    document.getElementById("modalTitle").textContent = "Adicionar Parceiro";
    parceiroAtual = null;
};

// Fechar modal
document.getElementById("fecharModal").onclick = () => {
    modal.style.display = "none";
    document.getElementById("formCadastro").reset();
    document.getElementById("mensagemCadastro").textContent = "";
};
window.onclick = e => {if(e.target==modal){modal.style.display="none"; document.getElementById("formCadastro").reset(); document.getElementById("mensagemCadastro").textContent="";}};

// Atualizar KPIs
async function atualizarKPI() {
    const snapshot = await db.collection("parceiros").get();
    const dados = snapshot.docs.map(d => ({id:d.id, ...d.data()}));

    document.getElementById("totalParceiros").textContent = dados.length;

    // Novos no mês
    const mesAtual = new Date().getMonth();
    const novos = dados.filter(d => {
        if(!d.cadastro) return false;
        return new Date(d.cadastro).getMonth() === mesAtual;
    });
    document.getElementById("novosParceiros").textContent = novos.length;

    // VIP
    const vips = dados.filter(d => d.status === "VIP");
    document.getElementById("vipParceiros").textContent = vips.length;

    // Maior faturamento
    const vendasSnap = await db.collection("vendas").get();
    const vendas = vendasSnap.docs.map(d => d.data());
    const faturamentoPorParceiro = {};
    vendas.forEach(v => {
        if(!faturamentoPorParceiro[v.parceiroId]) faturamentoPorParceiro[v.parceiroId] = 0;
        faturamentoPorParceiro[v.parceiroId] += v.valor || 0;
    });
    let maiorId = null, maiorValor = 0;
    for(let id in faturamentoPorParceiro){
        if(faturamentoPorParceiro[id] > maiorValor){
            maiorValor = faturamentoPorParceiro[id];
            maiorId = id;
        }
    }
    if(maiorId){
        const doc = await db.collection("parceiros").doc(maiorId).get();
        document.getElementById("parceiroTop").textContent = `${doc.data().nome} (R$ ${maiorValor.toFixed(2)})`;
    } else {
        document.getElementById("parceiroTop").textContent = "-";
    }
}

// Chamar ao carregar a página
atualizarKPI();

// Buscar parceiros
document.getElementById("btnBuscar").addEventListener("click", async () => {
    const busca = document.getElementById("buscaParceiro").value.toLowerCase();
    const statusSel = [...document.getElementById("filtroStatus").selectedOptions].map(o=>o.value);

    const snapshot = await db.collection("parceiros").get();
    const dados = snapshot.docs.map(d => ({id:d.id, ...d.data()}));

    const filtrados = dados.filter(d => {
        let incluir = true;
        if(busca && !d.nome.toLowerCase().includes(busca) && !d.email.toLowerCase().includes(busca) && !(d.cnpj||"").includes(busca)) incluir=false;
        if(statusSel.length && !statusSel.includes(d.status)) incluir=false;
        return incluir;
    });

    const tbody = document.querySelector("#tabelaParceiros tbody");
    tbody.innerHTML = "";
    filtrados.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.nome}</td><td>${d.email}</td><td>${d.telefone}</td><td>${d.cnpj||''}</td><td>${d.status}</td><td>R$ ${d.faturamento?.toFixed(2)||0}</td>`;
        tr.onclick = () => abrirEdicaoParceiro(d.id,d);
        tbody.appendChild(tr);
    });

    document.getElementById("listaParceiros").style.display = filtrados.length ? "block" : "none";
});

// Abrir edição parceiro
function abrirEdicaoParceiro(id, data){
    parceiroAtual = id;
    modal.style.display = "flex";
    document.getElementById("modalTitle").textContent = "Editar Parceiro";
    document.getElementById("nomeParceiro").value = data.nome || "";
    document.getElementById("telefoneParceiro").value = data.telefone || "";
    document.getElementById("emailParceiro").value = data.email || "";
    document.getElementById("cnpjParceiro").value = data.cnpj || "";
    document.getElementById("statusParceiro").value = data.status || "ativo";
}

// Salvar parceiro
document.getElementById("formCadastro").addEventListener("submit", async e=>{
    e.preventDefault();
    const nome = document.getElementById("nomeParceiro").value.trim();
    const telefone = document.getElementById("telefoneParceiro").value.trim();
    const email = document.getElementById("emailParceiro").value.trim();
    const cnpj = document.getElementById("cnpjParceiro").value.trim();
    const status = document.getElementById("statusParceiro").value;
    const mensagem = document.getElementById("mensagemCadastro");

    if(!nome || !telefone || !email){mensagem.style.color="red"; mensagem.textContent="Preencha todos os campos obrigatórios"; return;}

    try{
        if(parceiroAtual){
            await db.collection("parceiros").doc(parceiroAtual).update({nome, telefone, email, cnpj:cnpj||null, status});
            mensagem.style.color="green";
            mensagem.textContent="Parceiro atualizado com sucesso!";
        } else {
            await db.collection("parceiros").add({nome, telefone, email, cnpj:cnpj||null, status, cadastro:new Date().toISOString(), faturamento:0});
            mensagem.style.color="green";
            mensagem.textContent="Parceiro cadastrado com sucesso!";
        }
        setTimeout(()=>{
            modal.style.display="none";
            document.getElementById("formCadastro").reset();
            mensagem.textContent="";
            atualizarKPI();
        },1500);
    } catch(error){mensagem.style.color="red"; mensagem.textContent=error.message;}
});
</script>
</body>
</html>
