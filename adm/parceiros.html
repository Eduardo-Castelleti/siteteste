<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:red; color:white; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:16px;}
.card p {font-size:20px; font-weight:700;}
.card.total {background:#2980b9;}
.card.ativos {background:#1abc9c;}
.card.vendas {background:#27ae60;}
.card.combos {background:#8e44ad;}
.card.faturamento {background:#e74c3c;}
.search-bar {margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; flex-wrap:wrap;}
.search-bar input, .search-bar select {padding:10px; border-radius:5px; border:1px solid #ccc;}
.search-bar button {padding:10px 15px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.search-bar button:hover {background:#3498db;}
.graphs {display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-top:30px;}
canvas {background:#fff; border-radius:10px; padding:10px;}
.partner-list {margin-top:20px; background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.partner-list table {width:100%; border-collapse:collapse;}
.partner-list table th, .partner-list table td {padding:10px; border-bottom:1px solid #ddd; text-align:left; cursor:pointer;}
.partner-list table tr:hover {background:#f0f0f0;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;}
.modal-content {background:#fff; padding:20px; border-radius:10px; width:450px; max-width:90%; position:relative;}
.modal-content h2 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px;}
.modal-content input, .modal-content select {width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer;}
.modal-content button:hover {background:#2ecc71;}
.modal-close {position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;}
#mensagemCadastro{margin-top:10px; font-weight:500;}
</style>
</head>
<body>

<div class="sidebar">
<h2>Admin Pet</h2>
<a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
<a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
<a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
<a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
<a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
<a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
<a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
<a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
<a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
<a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
<a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
<a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<div class="main-content">
<h1>Parceiros <button id="btnAbrirCadastro">Cadastrar Parceiro</button></h1>

<div class="cards">
<div class="card total"><h3>Total de Parceiros</h3><p id="totalParceiros">0</p></div>
<div class="card ativos"><h3>Ativos</h3><p id="parceirosAtivos">0</p></div>
<div class="card vendas"><h3>Vendas</h3><p id="parceirosVendas">0</p></div>
<div class="card combos"><h3>Combos Vendidos</h3><p id="parceirosCombos">0</p></div>
<div class="card faturamento"><h3>Faturamento</h3><p id="parceirosFaturamento">R$ 0,00</p></div>
</div>

<div class="graphs">
<canvas id="graficoVendas"></canvas>
<canvas id="graficoCombos"></canvas>
<canvas id="graficoFaturamento"></canvas>
</div>

<div class="search-bar">
<input type="text" id="buscaParceiro" placeholder="Pesquisar por nome, CNPJ, e-mail, telefone">
<select id="filtroStatus" multiple>
<option value="ativo">Ativo</option>
<option value="inativo">Inativo</option>
</select>
<button id="btnBuscar"><i class="fas fa-search"></i> Buscar</button>
<button id="btnExportar"><i class="fas fa-file-csv"></i> Exportar CSV</button>
</div>

<!-- Modal Cadastro / Edição -->
<div class="modal" id="modalCadastro">
<div class="modal-content">
<span class="modal-close" id="fecharModal">&times;</span>
<h2 id="modalTitle">Adicionar Parceiro</h2>
<form id="formCadastro">
<label for="nomeParceiro">Nome *</label>
<input type="text" id="nomeParceiro" required>
<label for="cnpjParceiro">CNPJ *</label>
<input type="text" id="cnpjParceiro" placeholder="00.000.000/0000-00" required>
<label for="telefoneParceiro">Telefone *</label>
<input type="text" id="telefoneParceiro" placeholder="(99) 99999-9999" required>
<label for="emailParceiro">E-mail *</label>
<input type="email" id="emailParceiro" required>
<label for="responsavelParceiro">Responsável *</label>
<input type="text" id="responsavelParceiro" required>
<label for="telefoneRespParceiro">Telefone Resp *</label>
<input type="text" id="telefoneRespParceiro" required>
<label for="emailRespParceiro">E-mail Resp *</label>
<input type="email" id="emailRespParceiro" required>
<label for="enderecoParceiro">Endereço</label>
<input type="text" id="enderecoParceiro">
<button type="submit" id="btnSalvar">Salvar</button>
<p id="mensagemCadastro"></p>
</form>
</div>
</div>

<div class="partner-list">
<h3>Lista de Parceiros</h3>
<table id="tabelaParceiros">
<thead>
<tr>
<th>Nome</th><th>CNPJ</th><th>Telefone</th><th>E-mail</th><th>Responsável</th><th>Telefone Resp</th><th>E-mail Resp</th><th>Endereço</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
}; 
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Modal
let parceiroAtual = null;
let statusAtual = "ativo";

const modal = document.getElementById("modalCadastro");
document.getElementById("btnAbrirCadastro").onclick = ()=>{
    modal.style.display="flex";
    document.getElementById("modalTitle").textContent="Adicionar Parceiro";
    parceiroAtual=null;
    statusAtual="ativo";
};
document.getElementById("fecharModal").onclick = ()=>{
    modal.style.display="none";
    document.getElementById("formCadastro").reset();
    document.getElementById("mensagemCadastro").textContent="";
};
window.onclick = e=>{
  if(e.target==modal){
    modal.style.display="none"; 
    document.getElementById("formCadastro").reset(); 
    document.getElementById("mensagemCadastro").textContent="";
  }
};

// Atualizar KPIs
function atualizarKPIs(snapshot){
    let total=0, ativos=0, vendas=0, combos=0, faturamento=0;
    snapshot.forEach(doc=>{
        const p = doc.data();
        total++;
        if(p.status==="ativo") ativos++;
        vendas += p.vendas || 0;
        combos += p.combos || 0;
        faturamento += p.faturamento || 0;
    });
    document.getElementById("totalParceiros").textContent=total;
    document.getElementById("parceirosAtivos").textContent=ativos;
    document.getElementById("parceirosVendas").textContent=vendas;
    document.getElementById("parceirosCombos").textContent=combos;
    document.getElementById("parceirosFaturamento").textContent="R$ "+faturamento.toFixed(2);
}

// Carregar parceiros
function atualizarTabela(snapshot){
    const tbody=document.querySelector("#tabelaParceiros tbody");
    tbody.innerHTML="";
    snapshot.forEach(doc=>{
        const p = doc.data();
        p.id=doc.id;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.nome}</td><td>${p.cnpj||''}</td><td>${p.telefone||''}</td><td>${p.email||''}</td><td>${p.responsavel||''}</td>
            <td>${p.telefoneResp||''}</td><td>${p.emailResp||''}</td><td>${p.endereco||''}</td>`;
        tr.onclick = ()=>abrirEdicaoParceiro(p.id,p);
        tbody.appendChild(tr);
    });
    atualizarKPIs(snapshot);
}

// Abrir edição
function abrirEdicaoParceiro(id,data){
    parceiroAtual=id;
    statusAtual = data.status || "ativo";
    modal.style.display="flex";
    document.getElementById("modalTitle").textContent="Editar Parceiro";
    document.getElementById("nomeParceiro").value=data.nome||"";
    document.getElementById("cnpjParceiro").value=data.cnpj||"";
    document.getElementById("telefoneParceiro").value=data.telefone||"";
    document.getElementById("emailParceiro").value=data.email||"";
    document.getElementById("responsavelParceiro").value=data.responsavel||"";
    document.getElementById("telefoneRespParceiro").value=data.telefoneResp||"";
    document.getElementById("emailRespParceiro").value=data.emailResp||"";
    document.getElementById("enderecoParceiro").value=data.endereco||"";
}

// Salvar parceiro
document.getElementById("formCadastro").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const nome=document.getElementById("nomeParceiro").value.trim();
    const cnpj=document.getElementById("cnpjParceiro").value.trim();
    const telefone=document.getElementById("telefoneParceiro").value.trim();
    const email=document.getElementById("emailParceiro").value.trim();
    const responsavel=document.getElementById("responsavelParceiro").value.trim();
    const telefoneResp=document.getElementById("telefoneRespParceiro").value.trim();
    const emailResp=document.getElementById("emailRespParceiro").value.trim();
    const endereco=document.getElementById("enderecoParceiro").value.trim();
    const mensagem=document.getElementById("mensagemCadastro");

    if(!nome||!cnpj||!telefone||!email||!responsavel||!telefoneResp||!emailResp){
      mensagem.style.color="red"; 
      mensagem.textContent="Preencha todos os campos obrigatórios"; 
      return;
    }

    try{
        if(parceiroAtual){
            await db.collection("parceiros").doc(parceiroAtual).update({
                nome, cnpj, telefone, email, responsavel, telefoneResp, emailResp, endereco
            });
            mensagem.style.color="green";
            mensagem.textContent="Parceiro atualizado com sucesso!";
        }else{
            const senha=Math.random().toString(36).slice(-8)+"A1!";
            const userCredential=await auth.createUserWithEmailAndPassword(email,senha);
            await db.collection("parceiros").doc(userCredential.user.uid).set({
                nome, cnpj, telefone, email, responsavel, telefoneResp, emailResp, endereco,
                status:"ativo", vendas:0, combos:0, faturamento:0, cadastro:new Date().toISOString()
            });
            mensagem.style.color="green";
            mensagem.textContent="Parceiro cadastrado com sucesso!";
        }
        setTimeout(()=>{
          modal.style.display="none"; 
          document.getElementById("formCadastro").reset(); 
          mensagem.textContent="";
        },1500);
    }catch(error){
        console.error(error);
        mensagem.style.color="red"; 
        mensagem.textContent=error.message;
    }
});

// Snapshot
db.collection("parceiros").onSnapshot(snapshot=>{
    atualizarTabela(snapshot.docs);
});

// Filtro simples
document.getElementById("btnBuscar").addEventListener("click",()=>{
    db.collection("parceiros").get().then(snapshot=>{
        let resultados=[];
        snapshot.forEach(doc=>{resultados.push({...doc.data(), id:doc.id});});
        const busca=document.getElementById("buscaParceiro").value.toLowerCase();
        const statusSel=[...document.getElementById("filtroStatus").selectedOptions].map(o=>o.value);
        const filtrados=resultados.filter(p=>{
            let incluir=true;
            if(busca && !p.nome.toLowerCase().includes(busca)) incluir=false;
            if(statusSel.length && !statusSel.includes(p.status)) incluir=false;
            return incluir;
        });
        const tbody=document.querySelector("#tabelaParceiros tbody");
        tbody.innerHTML="";
        filtrados.forEach(p=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${p.nome}</td><td>${p.cnpj||''}</td><td>${p.telefone||''}</td><td>${p.email||''}</td><td>${p.responsavel||''}</td>
            <td>${p.telefoneResp||''}</td><td>${p.emailResp||''}</td><td>${p.endereco||''}</td>`;
          tr.onclick = ()=>abrirEdicaoParceiro(p.id,p);
          tbody.appendChild(tr);
        });
    });
});

// Exportar CSV
document.getElementById('btnExportar').addEventListener('click',()=>{
    let csv="Nome,CNPJ,Telefone,E-mail,Responsável,Telefone Resp,E-mail Resp,Endereço\n";
    document.querySelectorAll("#tabelaParceiros tbody tr").forEach(r=>{
        const cols=r.querySelectorAll("td");
        csv+=Array.from(cols).map(c=>c.textContent.replace(/,/g,";")).join(",")+"\n";
    });
    const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="parceiros.csv";
    link.click();
});

// Gráficos
let chartVendas, chartCombos, chartFaturamento;

function atualizarGraficos(snapshot){
    const labels=[], dataVendas=[], dataCombos=[], dataFaturamento=[];
    snapshot.forEach(doc=>{
        const p=doc.data();
        labels.push(p.nome);
        dataVendas.push(p.vendas||0);
        dataCombos.push(p.combos||0);
        dataFaturamento.push(p.faturamento||0);
    });

    const ctxVendas=document.getElementById('graficoVendas').getContext('2d');
    const ctxCombos=document.getElementById('graficoCombos').getContext('2d');
    const ctxFaturamento=document.getElementById('graficoFaturamento').getContext('2d');

    if(chartVendas) chartVendas.destroy();
    if(chartCombos) chartCombos.destroy();
    if(chartFaturamento) chartFaturamento.destroy();

    chartVendas=new Chart(ctxVendas,{
        type:'bar',
        data:{labels, datasets:[{label:'Vendas', data:dataVendas, backgroundColor:'#1abc9c'}]},
        options:{responsive:true, plugins:{legend:{display:false}}}
    });
    chartCombos=new Chart(ctxCombos,{
        type:'bar',
        data:{labels, datasets:[{label:'Combos Vendidos', data:dataCombos, backgroundColor:'#8e44ad'}]},
        options:{responsive:true, plugins:{legend:{display:false}}}
    });
    chartFaturamento=new Chart(ctxFaturamento,{
        type:'bar',
        data:{labels, datasets:[{label:'Faturamento (R$)', data:dataFaturamento, backgroundColor:'#e74c3c'}]},
        options:{responsive:true, plugins:{legend:{display:false}}}
    });
}

// Atualizar gráficos em tempo real
db.collection("parceiros").onSnapshot(snapshot=>{
    atualizarGraficos(snapshot.docs);
});
</script>
</body>
</html>
