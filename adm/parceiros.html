<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:red; color:white; border-radius:50%; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50; display:flex; justify-content:space-between; align-items:center;}
h1 button {padding:8px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer; transition:0.3s;}
h1 button:hover {background:#2ecc71;}
.search-bar {margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; flex-wrap:wrap;}
.search-bar input {padding:10px; border-radius:5px; border:1px solid #ccc;}
.search-bar button {padding:10px 15px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
.search-bar button:hover {background:#3498db;}
.partner-list {margin-top:20px; background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.partner-list table {width:100%; border-collapse:collapse;}
.partner-list table th, .partner-list table td {padding:10px; border-bottom:1px solid #ddd; text-align:left; cursor:pointer;}
.partner-list table tr:hover {background:#f0f0f0;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;}
.modal-content {background:#fff; padding:20px; border-radius:10px; width:600px; max-width:95%; position:relative; overflow-y:auto; max-height:90%;}
.modal-content h2 {margin-bottom:15px;}
.modal-content label {display:block; margin-top:10px;}
.modal-content input, .modal-content select, .modal-content textarea {width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc;}
.modal-content button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; background:#27ae60; color:white; cursor:pointer;}
.modal-content button:hover {background:#2ecc71;}
.modal-close {position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px;}
fieldset {margin-bottom:15px; border:1px solid #ccc; padding:10px; border-radius:5px;}
legend {font-weight:bold; padding:0 5px;}
#mensagemCadastroParceiro{margin-top:10px; font-weight:500;}
</style>
</head>
<body>

<div class="sidebar">
<h2>Admin Pet</h2>
<a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
<a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
<a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
<a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
<a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
<a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
<a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
<a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
<a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
<a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
<a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
<a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<div class="main-content">
<h1>Parceiros <button id="btnAbrirCadastroParceiro">Cadastrar Parceiro</button></h1>

<div class="search-bar">
<input type="text" id="buscaParceiro" placeholder="Pesquisar por nome, CNPJ, cidade">
<button id="btnBuscarParceiro"><i class="fas fa-search"></i> Buscar</button>
<button id="btnExportarParceiro"><i class="fas fa-file-csv"></i> Exportar CSV</button>
</div>

<div class="partner-list" id="partnerList" style="display:none;">
<h3>Lista de Parceiros</h3>
<table id="tabelaParceiros">
<thead>
<tr>
<th>Nome</th>
<th>CNPJ</th>
<th>Cidade</th>
<th>Telefone</th>
<th>Responsável</th>
<th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- Modal Cadastro / Edição Parceiro -->
<div class="modal" id="modalParceiro">
  <div class="modal-content">
    <span class="modal-close" id="fecharModalParceiro">&times;</span>
    <h2 id="modalTitleParceiro">Adicionar Parceiro</h2>
    <form id="formParceiro">
      
      <fieldset>
        <legend>Informações da Empresa</legend>
        <label for="nomeEmpresa">Nome da Empresa *</label>
        <input type="text" id="nomeEmpresa" required>
        <label for="cnpjEmpresa">CNPJ / CPF *</label>
        <input type="text" id="cnpjEmpresa" required>
        <label for="telefoneEmpresa">Telefone *</label>
        <input type="text" id="telefoneEmpresa" required>
        <label for="cepEmpresa">CEP *</label>
        <input type="text" id="cepEmpresa" required>
        <label for="ruaEmpresa">Rua *</label>
        <input type="text" id="ruaEmpresa" required>
        <label for="numeroEmpresa">Número *</label>
        <input type="text" id="numeroEmpresa" required>
        <label for="bairroEmpresa">Bairro *</label>
        <input type="text" id="bairroEmpresa" required>
        <label for="cidadeEmpresa">Cidade *</label>
        <input type="text" id="cidadeEmpresa" required>
        <label for="estadoEmpresa">Estado *</label>
        <input type="text" id="estadoEmpresa" required>
        <label for="websiteEmpresa">Website / Redes Sociais</label>
        <input type="text" id="websiteEmpresa" placeholder="https://">
      </fieldset>

      <fieldset>
        <legend>Serviços Oferecidos</legend>
        <label><input type="checkbox" name="servicos" value="Banho e Tosa"> Banho e Tosa</label><br>
        <label><input type="checkbox" name="servicos" value="Creche"> Creche</label><br>
        <label><input type="checkbox" name="servicos" value="Hospedagem"> Hospedagem</label><br>
        <label><input type="checkbox" name="servicos" value="Dog Walker"> Dog Walker</label><br>
        <label><input type="checkbox" name="servicos" value="Pet Sitter"> Pet Sitter</label><br>
        <label><input type="checkbox" name="servicos" value="Adestramento"> Adestramento</label><br>
        <label for="outrosServicos">Outros (opcional)</label>
        <input type="text" id="outrosServicos" placeholder="Descrever outros serviços">
      </fieldset>

      <fieldset>
        <legend>Informações do Responsável</legend>
        <label for="nomeResponsavel">Nome *</label>
        <input type="text" id="nomeResponsavel" required>
        <label for="telefoneResponsavel">Telefone *</label>
        <input type="text" id="telefoneResponsavel" required>
        <label for="emailResponsavel">E-mail *</label>
        <input type="email" id="emailResponsavel" required>
        <label for="cargoResponsavel">Cargo / Função</label>
        <input type="text" id="cargoResponsavel">
      </fieldset>

      <fieldset>
        <legend>Financeiro / Observações</legend>
        <label for="faixaFaturamento">Faixa de Faturamento</label>
        <input type="text" id="faixaFaturamento" placeholder="Ex: R$0-5.000">
        <label for="formasPagamento">Formas de Pagamento</label>
        <input type="text" id="formasPagamento" placeholder="Dinheiro, Cartão, Transferência">
        <label for="limiteCredito">Limite de Crédito</label>
        <input type="text" id="limiteCredito" placeholder="Ex: R$5.000">
        <label for="observacoesParceiro">Observações</label>
        <textarea id="observacoesParceiro" rows="3" placeholder="Notas internas"></textarea>
        <label for="statusParceiro">Status</label>
        <select id="statusParceiro">
          <option value="ativo">Ativo</option>
          <option value="inativo">Inativo</option>
          <option value="vip">VIP</option>
        </select>
      </fieldset>

      <button type="submit" id="btnSalvarParceiro">Salvar</button>
      <p id="mensagemCadastroParceiro"></p>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDVr6OOQRt2rB0kByInjqjdyoQCpnMAt7I",
  authDomain: "site-f6495.firebaseapp.com",
  projectId: "site-f6495",
  storageBucket: "site-f6495.firebasestorage.app",
  messagingSenderId: "230161402024",
  appId: "1:230161402024:web:462a911919ebf8a0809a9d",
  measurementId: "G-51G8XF6JH0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let parceiroAtual = null;
const modal = document.getElementById("modalParceiro");

// Abrir e fechar modal
document.getElementById("btnAbrirCadastroParceiro").onclick = ()=>{
  modal.style.display="flex";
  document.getElementById("modalTitleParceiro").textContent="Adicionar Parceiro";
  parceiroAtual=null;
};
document.getElementById("fecharModalParceiro").onclick = ()=>{
  modal.style.display="none";
  document.getElementById("formParceiro").reset();
  document.getElementById("mensagemCadastroParceiro").textContent="";
};
window.onclick = e => { if(e.target==modal){modal.style.display="none"; document.getElementById("formParceiro").reset(); document.getElementById("mensagemCadastroParceiro").textContent="";} };

// CEP automático
document.getElementById("cepEmpresa").addEventListener("blur", async ()=>{
  const cep = document.getElementById("cepEmpresa").value.replace(/\D/g,'');
  if(cep.length === 8){
    try{
      const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const data = await resp.json();
      if(!data.erro){
        document.getElementById("ruaEmpresa").value = data.logradouro || '';
        document.getElementById("bairroEmpresa").value = data.bairro || '';
        document.getElementById("cidadeEmpresa").value = data.localidade || '';
        document.getElementById("estadoEmpresa").value = data.uf || '';
      }
    }catch(err){ console.error("Erro CEP", err); }
  }
});

// Salvar / Editar parceiro
document.getElementById("formParceiro").addEventListener("submit", async e=>{
  e.preventDefault();
  const mensagem = document.getElementById("mensagemCadastroParceiro");
  const dados = {
    nome: document.getElementById("nomeEmpresa").value.trim(),
    cnpj: document.getElementById("cnpjEmpresa").value.trim(),
    telefone: document.getElementById("telefoneEmpresa").value.trim(),
    endereco: {
      cep: document.getElementById("cepEmpresa").value.trim(),
      rua: document.getElementById("ruaEmpresa").value.trim(),
      numero: document.getElementById("numeroEmpresa").value.trim(),
      bairro: document.getElementById("bairroEmpresa").value.trim(),
      cidade: document.getElementById("cidadeEmpresa").value.trim(),
      estado: document.getElementById("estadoEmpresa").value.trim()
    },
    website: document.getElementById("websiteEmpresa").value.trim(),
    servicos: [...document.querySelectorAll("input[name='servicos']:checked")].map(i=>i.value),
    outrosServicos: document.getElementById("outrosServicos").value.trim(),
    responsavel: {
      nome: document.getElementById("nomeResponsavel").value.trim(),
      telefone: document.getElementById("telefoneResponsavel").value.trim(),
      email: document.getElementById("emailResponsavel").value.trim(),
      cargo: document.getElementById("cargoResponsavel").value.trim()
    },
    financeiro: {
      faixaFaturamento: document.getElementById("faixaFaturamento").value.trim(),
      formasPagamento: document.getElementById("formasPagamento").value.trim(),
      limiteCredito: document.getElementById("limiteCredito").value.trim(),
      observacoes: document.getElementById("observacoesParceiro").value.trim()
    },
    status: document.getElementById("statusParceiro").value
  };

  if(!dados.nome || !dados.cnpj || !dados.telefone || !dados.responsavel.nome || !dados.responsavel.telefone || !dados.responsavel.email){
    mensagem.style.color="red";
    mensagem.textContent="Preencha todos os campos obrigatórios";
    return;
  }

  try{
    if(parceiroAtual){
      await db.collection("parceiros").doc(parceiroAtual).update(dados);
      mensagem.style.color="green";
      mensagem.textContent="Parceiro atualizado com sucesso!";
    } else {
      const docRef = await db.collection("parceiros").add(dados);
      parceiroAtual = docRef.id;
      mensagem.style.color="green";
      mensagem.textContent="Parceiro cadastrado com sucesso!";
    }
    setTimeout(()=>{
      modal.style.display="none";
      document.getElementById("formParceiro").reset();
      mensagem.textContent="";
    },1500);
  }catch(err){
    mensagem.style.color="red";
    mensagem.textContent=err.message;
  }
});

// Buscar parceiros
document.getElementById("btnBuscarParceiro").addEventListener("click", async ()=>{
  const busca = document.getElementById("buscaParceiro").value.toLowerCase();
  const tbody = document.querySelector("#tabelaParceiros tbody");
  tbody.innerHTML = "";
  const snapshot = await db.collection("parceiros").get();
  let encontrados = [];
  snapshot.forEach(doc=>{
    const p = doc.data();
    if(p.nome.toLowerCase().includes(busca) || p.cnpj.toLowerCase().includes(busca) || p.endereco.cidade.toLowerCase().includes(busca)){
      encontrados.push({id: doc.id, data: p});
    }
  });
  if(encontrados.length){
    document.getElementById("partnerList").style.display="block";
    encontrados.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p.data.nome}</td><td>${p.data.cnpj}</td><td>${p.data.endereco.cidade}</td><td>${p.data.telefone}</td><td>${p.data.responsavel.nome}</td><td>${p.data.status}</td>`;
      tr.onclick = ()=>abrirEdicaoParceiro(p.id, p.data);
      tbody.appendChild(tr);
    });
  } else {
    document.getElementById("partnerList").style.display="none";
  }
});

// Abrir edição
function abrirEdicaoParceiro(id,data){
  parceiroAtual = id;
  modal.style.display="flex";
  document.getElementById("modalTitleParceiro").textContent="Editar Parceiro";
  document.getElementById("nomeEmpresa").value = data.nome || "";
  document.getElementById("cnpjEmpresa").value = data.cnpj || "";
  document.getElementById("telefoneEmpresa").value = data.telefone || "";
  document.getElementById("cepEmpresa").value = data.endereco?.cep || "";
  document.getElementById("ruaEmpresa").value = data.endereco?.rua || "";
  document.getElementById("numeroEmpresa").value = data.endereco?.numero || "";
  document.getElementById("bairroEmpresa").value = data.endereco?.bairro || "";
  document.getElementById("cidadeEmpresa").value = data.endereco?.cidade || "";
  document.getElementById("estadoEmpresa").value = data.endereco?.estado || "";
  document.getElementById("websiteEmpresa").value = data.website || "";
  document.querySelectorAll("input[name='servicos']").forEach(cb=>{
    cb.checked = data.servicos?.includes(cb.value);
  });
  document.getElementById("outrosServicos").value = data.outrosServicos || "";
  document.getElementById("nomeResponsavel").value = data.responsavel?.nome || "";
  document.getElementById("telefoneResponsavel").value = data.responsavel?.telefone || "";
  document.getElementById("emailResponsavel").value = data.responsavel?.email || "";
  document.getElementById("cargoResponsavel").value = data.responsavel?.cargo || "";
  document.getElementById("faixaFaturamento").value = data.financeiro?.faixaFaturamento || "";
  document.getElementById("formasPagamento").value = data.financeiro?.formasPagamento || "";
  document.getElementById("limiteCredito").value = data.financeiro?.limiteCredito || "";
  document.getElementById("observacoesParceiro").value = data.financeiro?.observacoes || "";
  document.getElementById("statusParceiro").value = data.status || "ativo";
}

// Exportar CSV
document.getElementById("btnExportarParceiro").addEventListener("click", async ()=>{
  const snapshot = await db.collection("parceiros").get();
  let csv = "Nome,CNPJ,Cidade,Telefone,Responsável,Status\n";
  snapshot.forEach(doc=>{
    const p = doc.data();
    csv += `"${p.nome}","${p.cnpj}","${p.endereco?.cidade || ''}","${p.telefone}","${p.responsavel?.nome || ''}","${p.status}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "parceiros.csv";
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</div>
</body>
</html>
