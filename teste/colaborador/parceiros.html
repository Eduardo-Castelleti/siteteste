<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; display:flex; height:100vh; background:#f4f6f9; }
.sidebar { width:250px; background:#2c3e50; color:#fff; display:flex; flex-direction:column; padding-top:20px; }
.sidebar h2 { text-align:center; margin-bottom:30px; font-size:20px; font-weight:700; }
.sidebar a { padding:15px 20px; text-decoration:none; color:#ecf0f1; display:block; transition:0.3s; font-weight:500; }
.sidebar a:hover { background:#34495e; }
.sidebar a.active { background:#1abc9c; color:#fff; }
.content { flex:1; padding:20px; overflow-y:auto; }
h1 { font-size:24px; margin-bottom:20px; color:#2c3e50; }
.cards { display:flex; gap:20px; margin-bottom:20px; }
.card { flex:1; background:white; padding:20px; border-radius:8px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.card h3 { margin:0; font-size:18px; color:#555; }
.card p { font-size:22px; margin:5px 0 0; font-weight:bold; }
button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
button:hover { background:#2980b9; }
table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
th { background:#f8f9fa; }
tr:hover { background:#f1f1f1; cursor:pointer; }
.status-btn { cursor:pointer; padding:5px 10px; border:none; border-radius:5px; color:white; }
.ativo { background:#27ae60; }
.inativo { background:#c0392b; }
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:8px; width:700px; max-width:95%; max-height:90%; overflow-y:auto; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.close { cursor:pointer; padding:5px 10px; border:none; background:#c0392b; color:white; border-radius:5px; }
.nav-tabs { display:flex; gap:10px; margin-bottom:15px; }
.nav-tabs button { padding:8px 15px; border:none; border-radius:5px; cursor:pointer; background:#bdc3c7; color:#fff; }
.nav-tabs button.active { background:#3498db; }
.tab { display:none; }
.tab.active { display:block; }
.section-title { font-weight:700; margin:10px 0; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-bottom:10px; }
.input, .select, .textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; }
.checkline { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
.footer-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:15px; }
.footer-actions button { padding:8px 15px; }
.toast { position:fixed; right:16px; bottom:16px; background:#2ecc71; color:#fff; padding:10px 14px; border-radius:6px; box-shadow:0 2px 10px rgba(0,0,0,.2); display:none; z-index:9999; }
.toast.error { background:#e74c3c; }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Colaborador</h2>
  <a href="index.html">üì¶ Pedidos</a>
  <a href="clientes.html">üë• Clientes</a>
  <a href="parceiros.html" class="active">ü§ù Parceiros</a>
  <a href="produtos.html">üõí Produtos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="marketing.html">üì¢ Marketing</a>
  <a href="kpi.html">üìä KPI‚Äôs</a>
</div>

<div class="content">
  <h1>Parceiros</h1>

  <div class="cards">
    <div class="card"><h3>Total de Parceiros</h3><p id="totalParceiros">0</p></div>
    <div class="card"><h3>Ativos</h3><p id="ativosParceiros">0</p></div>
    <div class="card"><h3>Inativos</h3><p id="inativosParceiros">0</p></div>
  </div>

  <button onclick="abrirModal()">+ Cadastrar Parceiro</button>

  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Telefone</th>
        <th>Email</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="parceirosTable"></tbody>
  </table>
</div>

<!-- Modal Cadastro/Visualiza√ß√£o -->
<div class="modal" id="modalParceiro">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Novo Parceiro</h2>
      <button class="close" onclick="fecharModal()">Fechar</button>
    </div>
    <div class="nav-tabs" id="tabsHeader">
      <button class="tabBtn active" data-tab="tab-empresa">Empresa</button>
      <button class="tabBtn" data-tab="tab-servicos">Servi√ßos</button>
      <button class="tabBtn" data-tab="tab-responsavel">Respons√°vel</button>
      <button class="tabBtn" data-tab="tab-financeiro">Financeiro</button>
    </div>

    <form id="formParceiro">
      <input type="hidden" id="parceiroId">

      <div class="tab active" id="tab-empresa">
        <div class="section-title">Dados da Empresa</div>
        <div class="form-grid">
          <input class="input" id="nomeEmpresa" placeholder="Nome da Empresa *" required>
          <input class="input" id="cnpjCpf" placeholder="CNPJ / CPF *" required>
          <input class="input" id="telefoneEmpresa" placeholder="Telefone *" required>
          <input class="input" id="website" placeholder="Website / Redes sociais">
        </div>
        <div class="section-title" style="margin-top:10px;">Endere√ßo</div>
        <div class="form-grid">
          <input class="input" id="cep" placeholder="CEP *" maxlength="9" required>
          <input class="input" id="rua" placeholder="Rua">
          <input class="input" id="numero" placeholder="N√∫mero *" required>
          <input class="input" id="bairro" placeholder="Bairro">
          <input class="input" id="cidade" placeholder="Cidade">
          <input class="input" id="estado" placeholder="Estado">
        </div>
      </div>

      <div class="tab" id="tab-servicos">
        <div class="section-title">Servi√ßos oferecidos</div>
        <div class="checkline">
          <label><input type="checkbox" id="srvBanhoTosa"> Banho & Tosa</label>
          <label><input type="checkbox" id="srvCreche"> Creche</label>
          <label><input type="checkbox" id="srvHospedagem"> Hospedagem</label>
          <label><input type="checkbox" id="srvDogWalker"> Dog Walker</label>
          <label><input type="checkbox" id="srvPetSitter"> Pet Sitter</label>
          <label><input type="checkbox" id="srvAdestramento"> Adestramento</label>
          <label><input type="checkbox" id="srvOutros"> Outros</label>
        </div>
        <input class="input" id="descricaoOutros" placeholder="Descrever outros servi√ßos (opcional)">
      </div>

      <div class="tab" id="tab-responsavel">
        <div class="section-title">Respons√°vel</div>
        <div class="form-grid">
          <input class="input" id="respNome" placeholder="Nome *" required>
          <input class="input" id="respTelefone" placeholder="Telefone *" required>
          <input class="input" id="respEmail" type="email" placeholder="E-mail *" required>
          <input class="input" id="respCargo" placeholder="Cargo / Fun√ß√£o">
        </div>
      </div>

      <div class="tab" id="tab-financeiro">
        <div class="section-title">Financeiro</div>
        <div class="form-grid">
          <input class="input" id="faixaFaturamento" placeholder="Faixa de Faturamento">
          <input class="input" id="formasPagamento" placeholder="Formas de pagamento">
          <input class="input" id="limiteCredito" placeholder="Limite de Cr√©dito">
          <select class="select" id="statusParceiro">
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        <textarea class="textarea" id="observacoes" rows="3" placeholder="Observa√ß√µes"></textarea>
      </div>

      <div class="footer-actions">
        <button type="button" id="btnRedefinirSenha">Redefinir Senha</button>
        <button type="button" id="btnCancelar" onclick="fecharModal()">Cancelar</button>
        <button type="submit">Salvar Parceiro</button>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, getDoc, query, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCLBni8BY6zjHGMuoybZ06SBK4U9c1BhyE",
  authDomain: "petdudis-db2b2.firebaseapp.com",
  projectId: "petdudis-db2b2",
  storageBucket: "petdudis-db2b2.firebasestorage.app",
  messagingSenderId: "410321083813",
  appId: "1:410321083813:web:eaf0082878a8281eab5c4c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const parceirosRef = collection(db,'parceiros');

const toastEl = document.getElementById('toast');
function showToast(msg,isError=false){
  toastEl.textContent=msg;
  toastEl.classList.toggle('error',!!isError);
  toastEl.style.display='block';
  setTimeout(()=>toastEl.style.display='none',2500);
}

const modal = document.getElementById('modalParceiro');
const form = document.getElementById('formParceiro');
const tbody = document.getElementById('parceirosTable');
let editId = null;

window.abrirModal = ()=>{
  editId=null;
  document.getElementById('modalTitle').textContent="Novo Parceiro";
  form.reset();
  setActiveTab('tab-empresa');
  modal.style.display='flex';
};
window.fecharModal = ()=>{ modal.style.display='none'; };

// Tabs
function setActiveTab(id){
  document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const btn=document.querySelector(`.tabBtn[data-tab="${id}"]`);
  if(btn) btn.classList.add('active');
  const tab=document.getElementById(id);
  if(tab) tab.classList.add('active');
}
document.getElementById('tabsHeader').addEventListener('click', (e)=>{
  const btn = e.target.closest('.tabBtn'); if(!btn) return; setActiveTab(btn.dataset.tab);
});

// Coletar dados
function coletarDadosForm(){
  const servicos={
    banhoTosa: document.getElementById('srvBanhoTosa').checked,
    creche: document.getElementById('srvCreche').checked,
    hospedagem: document.getElementById('srvHospedagem').checked,
    dogWalker: document.getElementById('srvDogWalker').checked,
    petSitter: document.getElementById('srvPetSitter').checked,
    adestramento: document.getElementById('srvAdestramento').checked,
    outros: document.getElementById('srvOutros').checked,
    descricaoOutros: document.getElementById('descricaoOutros').value||''
  };
  const endereco={
    cep: document.getElementById('cep').value||'',
    rua: document.getElementById('rua').value||'',
    numero: document.getElementById('numero').value||'',
    bairro: document.getElementById('bairro').value||'',
    cidade: document.getElementById('cidade').value||'',
    estado: document.getElementById('estado').value||''
  };
  const responsavel={
    nome: document.getElementById('respNome').value||'',
    telefone: document.getElementById('respTelefone').value||'',
    email: document.getElementById('respEmail').value||'',
    cargo: document.getElementById('respCargo').value||''
  };
  const financeiro={
    faixaFaturamento: document.getElementById('faixaFaturamento').value||'',
    formasPagamento: document.getElementById('formasPagamento').value||'',
    limiteCredito: document.getElementById('limiteCredito').value||''
  };
  return {
    nomeEmpresa: document.getElementById('nomeEmpresa').value,
    cnpjCpf: document.getElementById('cnpjCpf').value,
    telefoneEmpresa: document.getElementById('telefoneEmpresa').value||'',
    website: document.getElementById('website').value||'',
    endereco, servicos, responsavel, financeiro,
    observacoes: document.getElementById('observacoes').value||'',
    status: document.getElementById('statusParceiro').value||'Ativo'
  };
}

// Tipo a partir dos servi√ßos
function tipoAPartirServicos(s={}){
  if(s.banhoTosa) return 'Banho & Tosa';
  if(s.creche) return 'Creche';
  if(s.hospedagem) return 'Hospedagem';
  if(s.dogWalker) return 'Dog Walker';
  if(s.petSitter) return 'Pet Sitter';
  if(s.adestramento) return 'Adestramento';
  if(s.outros) return 'Outros';
  return '‚Äî';
}

// Preencher formul√°rio para edi√ß√£o/visualiza√ß√£o
function preencherFormulario(id,p){
  editId=id||null;
  document.getElementById('modalTitle').textContent="Editar Parceiro";
  document.getElementById('parceiroId').value=id||'';
  document.getElementById('nomeEmpresa').value=p.nomeEmpresa||'';
  document.getElementById('cnpjCpf').value=p.cnpjCpf||'';
  document.getElementById('telefoneEmpresa').value=p.telefoneEmpresa||'';
  document.getElementById('website').value=p.website||'';
  const e=p.endereco||{};
  document.getElementById('cep').value=e.cep||'';
  document.getElementById('rua').value=e.rua||'';
  document.getElementById('numero').value=e.numero||'';
  document.getElementById('bairro').value=e.bairro||'';
  document.getElementById('cidade').value=e.cidade||'';
  document.getElementById('estado').value=e.estado||'';
  const s=p.servicos||{};
  document.getElementById('srvBanhoTosa').checked=!!s.banhoTosa;
  document.getElementById('srvCreche').checked=!!s.creche;
  document.getElementById('srvHospedagem').checked=!!s.hospedagem;
  document.getElementById('srvDogWalker').checked=!!s.dogWalker;
  document.getElementById('srvPetSitter').checked=!!s.petSitter;
  document.getElementById('srvAdestramento').checked=!!s.adestramento;
  document.getElementById('srvOutros').checked=!!s.outros;
  document.getElementById('descricaoOutros').value=s.descricaoOutros||'';
  const r=p.responsavel||{};
  document.getElementById('respNome').value=r.nome||'';
  document.getElementById('respTelefone').value=r.telefone||'';
  document.getElementById('respEmail').value=r.email||'';
  document.getElementById('respCargo').value=r.cargo||'';
  const f=p.financeiro||{};
  document.getElementById('faixaFaturamento').value=f.faixaFaturamento||'';
  document.getElementById('formasPagamento').value=f.formasPagamento||'';
  document.getElementById('limiteCredito').value=f.limiteCredito||'';
  document.getElementById('statusParceiro').value=p.status||'Ativo';
  document.getElementById('observacoes').value=p.observacoes||'';
}

// CNPJ duplicado
async function cnpjDuplicado(cnpj){
  const q=query(parceirosRef, orderBy('cnpjCpf'));
  let exists=false;
  const snapshot=await getDocs(q);
  snapshot.forEach(docSnap=>{
    if(docSnap.data().cnpjCpf===cnpj && docSnap.id!==editId) exists=true;
  });
  return exists;
}

// Submit
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const payload=coletarDadosForm();
  if(!payload.nomeEmpresa || !payload.cnpjCpf || !payload.responsavel.email){
    showToast('Preencha Nome, CNPJ/CPF e E-mail do respons√°vel',true);
    return;
  }
  if(await cnpjDuplicado(payload.cnpjCpf)){
    showToast('J√° existe um parceiro cadastrado com esse CNPJ/CPF',true);
    return;
  }
  try{
    if(editId){
      await updateDoc(doc(db,'parceiros',editId), {...payload, updatedAt:serverTimestamp()});
      showToast('Parceiro atualizado com sucesso!');
    }else{
      const docRef=await addDoc(parceirosRef,{...payload, createdAt:serverTimestamp()});
      try{
        await createUserWithEmailAndPassword(auth,payload.responsavel.email,'123456');
        await sendPasswordResetEmail(auth,payload.responsavel.email);
      }catch(err){ console.error('Auth error',err); }
      showToast('Parceiro cadastrado com sucesso!');
    }
    fecharModal();
  }catch(err){
    console.error(err);
    showToast('Erro ao salvar parceiro',true);
  }
});

// Bot√£o redefinir senha
document.getElementById('btnRedefinirSenha').addEventListener('click', async ()=>{
  const email=document.getElementById('respEmail').value.trim();
  if(!email){ showToast('Preencha o e-mail do respons√°vel',true); return; }
  try{
    await sendPasswordResetEmail(auth,email);
    showToast('E-mail de redefini√ß√£o enviado!');
  }catch(err){ console.error(err); showToast('Erro ao enviar e-mail',true); }
});

// Atualizar tabela em tempo real
onSnapshot(parceirosRef, snapshot=>{
  tbody.innerHTML='';
  let total=0, ativos=0, inativos=0;
  snapshot.forEach(docSnap=>{
    const p=docSnap.data(); total++;
    if(p.status==='Ativo') ativos++; else inativos++;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.nomeEmpresa||'‚Äî'}</td>
      <td>${tipoAPartirServicos(p.servicos)}</td>
      <td>${p.telefoneEmpresa||'‚Äî'}</td>
      <td>${p.responsavel?.email||'‚Äî'}</td>
      <td><button class="status-btn ${p.status==='Ativo'?'ativo':'inativo'}" onclick="toggleStatus('${docSnap.id}','${p.status}')">${p.status}</button></td>
      <td><button onclick="editarParceiro('${docSnap.id}')">Editar</button></td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('totalParceiros').textContent=total;
  document.getElementById('ativosParceiros').textContent=ativos;
  document.getElementById('inativosParceiros').textContent=inativos;
});

// Editar
window.editarParceiro=async id=>{
  const docSnap=await getDoc(doc(parceirosRef,id));
  if(docSnap.exists()){ preencherFormulario(id,docSnap.data()); abrirModal(); }
};

// Toggle status
window.toggleStatus=async(id,status)=>{
  const newStatus=status==='Ativo'?'Inativo':'Ativo';
  await updateDoc(doc(parceirosRef,id),{status:newStatus,updatedAt:serverTimestamp()});
};
</script>

</body>
</html>
