<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; display:flex; height:100vh; background:#f4f6f9; }
.sidebar { width:250px; background:#2c3e50; color:#fff; display:flex; flex-direction:column; padding-top:20px; }
.sidebar h2 { text-align:center; margin-bottom:30px; font-size:20px; font-weight:700; }
.sidebar a { padding:15px 20px; text-decoration:none; color:#ecf0f1; display:block; transition:0.3s; font-weight:500; }
.sidebar a:hover { background:#34495e; }
.sidebar a.active { background:#1abc9c; color:#fff; }
.content { flex:1; padding:20px; overflow-y:auto; }
h1 { font-size:24px; margin-bottom:20px; color:#2c3e50; }
.cards { display:flex; gap:20px; margin-bottom:20px; }
.card { flex:1; background:white; padding:20px; border-radius:8px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.card h3 { margin:0; font-size:18px; color:#555; }
.card p { font-size:22px; margin:5px 0 0; font-weight:bold; }
button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
button:hover { background:#2980b9; }
table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
th { background:#f8f9fa; }
tr:hover { background:#f1f1f1; cursor:pointer; }
.status-btn { cursor:pointer; padding:5px 10px; border:none; border-radius:5px; color:white; }
.ativo { background:#27ae60; }
.inativo { background:#c0392b; }
.toast { position:fixed; right:16px; bottom:16px; background:#2ecc71; color:#fff; padding:10px 14px; border-radius:6px; box-shadow:0 2px 10px rgba(0,0,0,.2); display:none; z-index:9999; }
.toast.error { background:#e74c3c; }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Colaborador</h2>
  <a href="index.html">üì¶ Pedidos</a>
  <a href="clientes.html">üë• Clientes</a>
  <a href="parceiros.html" class="active">ü§ù Parceiros</a>
  <a href="produtos.html">üõí Produtos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="marketing.html">üì¢ Marketing</a>
  <a href="kpi.html">üìä KPI‚Äôs</a>
</div>

<div class="content">
  <h1>Parceiros</h1>

  <div class="cards">
    <div class="card"><h3>Total de Parceiros</h3><p id="totalParceiros">0</p></div>
    <div class="card"><h3>Ativos</h3><p id="ativosParceiros">0</p></div>
    <div class="card"><h3>Inativos</h3><p id="inativosParceiros">0</p></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Telefone</th>
        <th>Email</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="parceirosTable"></tbody>
  </table>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCLBni8BY6zjHGMuoybZ06SBK4U9c1BhyE",
  authDomain: "petdudis-db2b2.firebaseapp.com",
  projectId: "petdudis-db2b2",
  storageBucket: "petdudis-db2b2.firebasestorage.app",
  messagingSenderId: "410321083813",
  appId: "1:410321083813:web:eaf0082878a8281eab5c4c"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const parceirosRef = collection(db, "parceiros");

// Toast
const toastEl = document.getElementById('toast');
function showToast(msg, isError=false){
  toastEl.textContent = msg;
  toastEl.classList.toggle('error', !!isError);
  toastEl.style.display = 'block';
  setTimeout(()=> toastEl.style.display='none', 2500);
}

// Fun√ß√£o para determinar tipo a partir dos servi√ßos
function tipoAPartirServicos(s = {}) {
  if(s.banhoTosa) return 'Banho & Tosa';
  if(s.creche) return 'Creche';
  if(s.hospedagem) return 'Hospedagem';
  if(s.dogWalker) return 'Dog Walker';
  if(s.petSitter) return 'Pet Sitter';
  if(s.adestramento) return 'Adestramento';
  if(s.outros) return 'Outros';
  return '‚Äî';
}

// Listagem em tempo real
const tbody = document.getElementById('parceirosTable');
onSnapshot(query(parceirosRef, orderBy('criadoEm','desc')), (snap)=>{
  tbody.innerHTML = '';
  let total=0, ativos=0, inativos=0;
  snap.forEach(d=>{
    total++;
    const p = d.data();
    const status = p.status === 'Inativo' ? 'Inativo' : 'Ativo';
    if(status==='Ativo') ativos++; else inativos++;

    const emailExibir = (p.responsavel && p.responsavel.email) || '';
    const tipo = tipoAPartirServicos(p.servicos);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.nomeEmpresa || ''}</td>
      <td>${tipo}</td>
      <td>${p.telefoneEmpresa || ''}</td>
      <td>${emailExibir}</td>
      <td><button class="status-btn ${status==='Ativo'?'ativo':'inativo'}" data-id="${d.id}" data-status="${status}">${status}</button></td>
      <td>
        <button class="btn-reset-senha" data-email="${emailExibir}">Redefinir Senha</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('totalParceiros').textContent = total;
  document.getElementById('ativosParceiros').textContent = ativos;
  document.getElementById('inativosParceiros').textContent = inativos;
}, (err)=> { console.error(err); showToast('Erro ao carregar parceiros.', true); });

// A√ß√µes da tabela (delega√ß√£o)
tbody.addEventListener('click', async (e)=>{
  const btnStatus = e.target.closest('.status-btn');
  const btnReset = e.target.closest('.btn-reset-senha');

  if(btnStatus){
    const id = btnStatus.dataset.id;
    const atual = btnStatus.dataset.status === 'Ativo' ? 'Ativo' : 'Inativo';
    const novo = atual==='Ativo' ? 'Inativo' : 'Ativo';
    try{
      await updateDoc(doc(db,'parceiros',id), { status:novo });
      showToast(`Status atualizado para ${novo}`);
    }catch(err){ console.error(err); showToast('Erro ao atualizar status.', true);}
  }

  if(btnReset){
    const email = btnReset.dataset.email;
    if(!email){ showToast('Parceiro n√£o possui e-mail cadastrado.', true); return; }
    try{
      await sendPasswordResetEmail(auth, email);
      showToast(`E-mail de redefini√ß√£o enviado para ${email}`);
    }catch(err){ console.error(err); showToast('Erro ao enviar e-mail: '+(err.message||''), true);}
  }
});
</script>

</body>
</html>
