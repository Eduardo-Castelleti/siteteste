<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Marketing / Promoções</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Exportação PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto',sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:#e74c3c; color:white; border-radius:12px; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:16px; color:#2c3e50;}
.top-bar {display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:16px;}
.actions {display:flex; gap:10px; align-items:center;}
button {padding:10px 14px; border:none; border-radius:8px; background:#2980b9; color:white; cursor:pointer; transition:0.2s; font-weight:600;}
button:hover {background:#3498db;}
select, input[type="month"] {padding:10px; border:1px solid #cfd8dc; border-radius:8px; background:#fff;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(230px,1fr)); gap:16px; margin-bottom:18px;}
.card {padding:18px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); color:#fff; position:relative;}
.card h3 {margin-bottom:6px; font-size:14px; opacity:.95; font-weight:700;}
.card p {font-size:22px; font-weight:800;}
.card small {opacity:.85;}
.card.ativas {background:#27ae60;}
.card.impactados {background:#2980b9;}
.card.conversao {background:#f39c12;}
.card.receita {background:#8e44ad;}
.card.proximas {background:#16a085;}
.card.roi {background:#2c3e50;}
.card.cpc {background:#7f8c8d;}
.kpi-grid {display:grid; grid-template-columns: repeat(auto-fit,minmax(230px,1fr)); gap:16px; margin-bottom:18px;}
.panel {background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; margin-bottom:16px;}
.panel h2 {font-size:18px; color:#2c3e50; margin-bottom:8px;}
.graph {background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:10px; margin-bottom:16px;}
.graph canvas {background:#fff; border-radius:8px;}
.badge-high {position:absolute; top:12px; right:12px; background:#2ecc71; color:#fff; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800;}
.table {width:100%; border-collapse:collapse;}
.table th, .table td {text-align:left; padding:10px; border-bottom:1px solid #eceff1; font-size:14px;}
.table th {background:#fafbfc; font-weight:700; color:#37474f;}
.tag {display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700;}
.tag.good {background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;}
.tag.warn {background:#fff8e1; color:#f57f17; border:1px solid #ffecb3;}
.tag.bad  {background:#ffebee; color:#c62828; border:1px solid #ffcdd2;}
.helper {font-size:12px; color:#607d8b;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Pet</h2>
  <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
  <a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
  <a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
  <a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
  <a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
  <a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
  <a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
  <a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
  <a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
  <a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
  <a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
  <a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
  <a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<div class="main-content" id="report-root">
  <h1>Marketing / Promoções</h1>

  <div class="top-bar">
    <div class="actions">
      <select id="filtroPeriodo">
        <option value="30">Últimos 30 dias</option>
        <option value="90">Últimos 3 meses</option>
        <option value="365" selected>Últimos 12 meses</option>
        <option value="custom">Período personalizado</option>
      </select>
      <input type="month" id="mesInicio" style="display:none;">
      <input type="month" id="mesFim" style="display:none;">
      <button id="btnAplicar">Aplicar</button>
    </div>
    <div class="actions">
      <button onclick="window.location.href='cadastrar_campanha.html'"><i class="fas fa-plus"></i> Criar Nova Campanha</button>
      <button id="btnExportar"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    </div>
  </div>

  <!-- KPIs Principais -->
  <div class="cards" id="kpi-primarios">
    <div class="card ativas"><h3>Campanhas Ativas</h3><p id="kpiAtivas">0</p></div>
    <div class="card impactados"><h3>Clientes Impactados</h3><p id="kpiImpactados">0</p></div>
    <div class="card conversao"><h3>Conversão Média</h3><p id="kpiConversao">0%</p></div>
    <div class="card receita"><h3>Receita Gerada</h3><p id="kpiReceita">R$ 0,00</p></div>
    <div class="card proximas"><h3>Próximas Campanhas</h3><p id="kpiProximas">0</p></div>
  </div>

  <!-- KPIs Estratégicos -->
  <div class="kpi-grid" id="kpi-estrategicos">
    <div class="card roi">
      <h3>ROI Médio (ponderado)</h3>
      <p id="kpiROI">0%</p>
      <small class="helper">Calculado por (∑(receita−custo))/∑custo</small>
    </div>
    <div class="card cpc">
      <h3>Custo por Cliente Impactado</h3>
      <p id="kpiCPC">R$ 0,00</p>
      <small class="helper">∑custo ÷ ∑impactados</small>
    </div>
    <div class="card receita" id="bestCampaignCard">
      <span class="badge-high">DESTAQUE</span>
      <h3>Melhor Campanha</h3>
      <p id="kpiBestCampaign">—</p>
      <small class="helper" id="kpiBestCampaignMeta">Maior ROI</small>
    </div>
  </div>

  <!-- Insights -->
  <div class="panel" id="painel-insights">
    <h2>Insights automáticos</h2>
    <div id="insightsLista" class="helper">Carregando insights…</div>
  </div>

  <!-- Gráficos -->
  <div class="graph"><canvas id="graficoReceitaCampanhas" height="140"></canvas></div>
  <div class="graph"><canvas id="graficoConversaoCampanhas" height="140"></canvas></div>
  <div class="graph"><canvas id="graficoEvolucaoMensal" height="160"></canvas></div>

  <!-- Top campanhas -->
  <div class="panel">
    <h2>Top campanhas no período</h2>
    <table class="table" id="tabelaTop">
      <thead>
        <tr>
          <th>Campanha</th>
          <th>Receita</th>
          <th>ROI</th>
          <th>Conversão</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody><!-- preenchido via JS --></tbody>
    </table>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
/* ========= CONFIG FIREBASE ========= */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJETO.firebaseapp.com",
  projectId: "SEU_PROJETO",
  storageBucket: "SEU_PROJETO.appspot.com",
  messagingSenderId: "SEU_SENDER_ID",
  appId: "SEU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========= UTIL ========= */
const BRL = v => (isFinite(v)? v:0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const PCT = v => `${(isFinite(v)? v:0).toFixed(1)}%`;
const toDate = (d)=> {
  if(!d) return null;
  if(d.toDate) return d.toDate(); // Firestore Timestamp
  const nd = new Date(d);
  return isNaN(nd)? null : nd;
};
function monthKey(date){ return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`; }
function addInsight(msg){ const box=document.getElementById('insightsLista'); const p=document.createElement('p'); p.textContent='• '+msg; box.appendChild(p); }

/* ========= FILTRO PERÍODO ========= */
const filtroPeriodo = document.getElementById('filtroPeriodo');
const mesInicio = document.getElementById('mesInicio');
const mesFim = document.getElementById('mesFim');
const btnAplicar = document.getElementById('btnAplicar');

filtroPeriodo.addEventListener('change', ()=>{
  const custom = filtroPeriodo.value === 'custom';
  mesInicio.style.display = custom? 'inline-block':'none';
  mesFim.style.display = custom? 'inline-block':'none';
});

btnAplicar.addEventListener('click', carregar);

/* ========= CHARTS ========= */
let chartReceita, chartConversao, chartEvolucao;
function ensureCharts(){
  if(chartReceita) chartReceita.destroy();
  if(chartConversao) chartConversao.destroy();
  if(chartEvolucao) chartEvolucao.destroy();

  chartReceita = new Chart(document.getElementById('graficoReceitaCampanhas').getContext('2d'), {
    type:'bar',
    data:{labels:[], datasets:[{label:'Receita por campanha', data:[], borderWidth:1}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
  chartConversao = new Chart(document.getElementById('graficoConversaoCampanhas').getContext('2d'), {
    type:'bar',
    data:{labels:[], datasets:[{label:'Conversão (%) por campanha', data:[], borderWidth:1}]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
  chartEvolucao = new Chart(document.getElementById('graficoEvolucaoMensal').getContext('2d'), {
    type:'line',
    data:{labels:[], datasets:[
      {label:'Receita mensal', data:[], tension:.3},
      {label:'Engajamento mensal', data:[], tension:.3}
    ]},
    options:{responsive:true}
  });
}

/* ========= EXPORTAÇÃO PDF ========= */
document.getElementById('btnExportar').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt', format:'a4'});
  const root = document.getElementById('report-root');
  const scale = 2;

  const canvas = await html2canvas(root, {scale, useCORS:true});
  const imgData = canvas.toDataURL('image/png');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 40;
  const imgHeight = canvas.height * imgWidth / canvas.width;

  let y = 20;
  pdf.addImage(imgData, 'PNG', 20, y, imgWidth, imgHeight);
  // Se a imagem for maior que 1 página, faz o split simples
  let heightLeft = imgHeight - (pageHeight - 40);
  while(heightLeft > 0){
    pdf.addPage();
    y = 20;
    pdf.addImage(imgData, 'PNG', 20, y - (imgHeight - heightLeft), imgWidth, imgHeight);
    heightLeft -= (pageHeight - 40);
  }
  pdf.save('marketing-relatorio.pdf');
});

/* ========= CARREGAMENTO E CÁLCULOS ========= */
async function carregar(){
  document.getElementById('insightsLista').textContent = '';
  ensureCharts();

  // Determina janela de datas
  const hoje = new Date();
  let startDate, endDate;
  const val = filtroPeriodo.value;
  if(val === 'custom'){
    if(!mesInicio.value || !mesFim.value){
      alert('Selecione mês inicial e final.');
      return;
    }
    startDate = new Date(mesInicio.value + '-01T00:00:00');
    endDate = new Date(mesFim.value + '-01T00:00:00');
    // fim do mês selecionado:
    endDate = new Date(endDate.getFullYear(), endDate.getMonth()+1, 0, 23,59,59,999);
  } else {
    const dias = parseInt(val || '365',10);
    startDate = new Date(hoje.getTime() - dias*24*60*60*1000);
    endDate = hoje;
  }

  // Busca campanhas (client-side filter para simplificar)
  const snap = await db.collection('campanhas').get();

  // Agregadores
  let campanhas = [];
  snap.forEach(doc=>{
    const c = doc.data();
    const di = toDate(c.dataInicio);
    const df = toDate(c.dataFim) || toDate(c.dataInicio) || hoje;

    // campanha entra se houver OVERLAP com a janela
    const overlap = (!di || df >= startDate) && (!df || di <= endDate);
    if(overlap){
      campanhas.push({
        id: doc.id,
        nome: c.nome || 'Campanha',
        status: (c.status || '').toLowerCase(),
        inicio: di,
        fim: df,
        impactados: Number(c.clientesImpactados || 0),
        receita: Number(c.receitaGerada || 0),
        custo: Number(c.custo || 0),
        conversao: Number(c.conversao || 0),
        engajamento: Number(c.engajamento || 0)
      });
    }
  });

  // KPIs básicos
  const totalImpactados = campanhas.reduce((s,c)=>s+c.impactados,0);
  const totalReceita = campanhas.reduce((s,c)=>s+c.receita,0);
  const totalCusto = campanhas.reduce((s,c)=>s+c.custo,0);
  const mediasConversao = campanhas.length ? campanhas.reduce((s,c)=>s+c.conversao,0)/campanhas.length : 0;

  // Ativas e próximas (considerando hoje)
  const ativas = campanhas.filter(c=>{
    const h = new Date();
    return c.status==='ativa' && c.inicio && c.fim && c.inicio<=h && c.fim>=h;
  }).length;
  const proximas = campanhas.filter(c=> c.inicio && c.inicio > new Date()).length;

  // ROI médio ponderado
  const roiPond = totalCusto>0 ? ((totalReceita - totalCusto)/totalCusto)*100 : 0;

  // CPCI (custo por cliente impactado)
  const cpci = totalImpactados>0 ? totalCusto/totalImpactados : 0;

  // Melhor campanha (maior ROI; se custo=0, usa receita)
  function roiCamp(c){ return c.custo>0 ? ((c.receita - c.custo)/c.custo)*100 : (c.receita>0? 999 : 0); }
  let melhor = null;
  campanhas.forEach(c=>{
    c._roi = roiCamp(c);
    if(!melhor || c._roi > melhor._roi) melhor = c;
  });

  // Preenche KPIs
  document.getElementById('kpiAtivas').textContent = ativas;
  document.getElementById('kpiImpactados').textContent = totalImpactados;
  document.getElementById('kpiConversao').textContent = PCT(mediasConversao);
  document.getElementById('kpiReceita').textContent = BRL(totalReceita);
  document.getElementById('kpiProximas').textContent = proximas;
  document.getElementById('kpiROI').textContent = PCT(roiPond);
  document.getElementById('kpiCPC').textContent = BRL(cpci);
  document.getElementById('kpiBestCampaign').textContent = melhor? `${melhor.nome}` : '—';
  document.getElementById('kpiBestCampaignMeta').textContent = melhor? `ROI: ${PCT(melhor._roi)} | Receita: ${BRL(melhor.receita)}` : '—';

  // Gráfico: receita por campanha
  const labelsCamp = campanhas.map(c=>c.nome);
  chartReceita.data.labels = labelsCamp;
  chartReceita.data.datasets[0].data = campanhas.map(c=>c.receita);
  chartReceita.update();

  // Gráfico: conversão por campanha
  chartConversao.data.labels = labelsCamp;
  chartConversao.data.datasets[0].data = campanhas.map(c=>c.conversao);
  chartConversao.update();

  // Evolução mensal (somatórios)
  const mensal = {};
  campanhas.forEach(c=>{
    const k = c.inicio? monthKey(c.inicio) : monthKey(new Date());
    if(!mensal[k]) mensal[k] = {receita:0, eng:0};
    mensal[k].receita += c.receita;
    mensal[k].eng += c.engajamento;
  });
  const ordenadas = Object.keys(mensal).sort(); // YYYY-MM
  chartEvolucao.data.labels = ordenadas;
  chartEvolucao.data.datasets[0].data = ordenadas.map(k=>mensal[k].receita);
  chartEvolucao.data.datasets[1].data = ordenadas.map(k=>mensal[k].eng);
  chartEvolucao.update();

  // Insights automáticos
  const convAvg = mediasConversao;
  const receitaMedia = campanhas.length ? totalReceita/campanhas.length : 0;
  const acimaMedia = campanhas.filter(c=>c.receita > receitaMedia);
  const topNome = melhor? melhor.nome : null;

  if(campanhas.length===0){
    addInsight('Nenhuma campanha no período selecionado.');
  } else {
    if(topNome) addInsight(`“${topNome}” teve o melhor ROI no período (${PCT(melhor._roi)}).`);
    addInsight(`Conversão média das campanhas: ${PCT(convAvg)}.`);
    addInsight(`${acimaMedia.length} de ${campanhas.length} campanhas superaram a receita média (${BRL(receitaMedia)}).`);
    if(roiPond>0) addInsight(`ROI médio ponderado positivo (${PCT(roiPond)}), sugerindo eficiência geral do investimento.`);
    if(cpci>0) addInsight(`Custo por cliente impactado: ${BRL(cpci)}. Compare com ticket médio para avaliar rentabilidade.`);
    // Projeção simples de impacto: tendência dos últimos 3 meses
    if(ordenadas.length>=3){
      const ult = ordenadas.slice(-3).map(k=>mensal[k].receita);
      const trend = ult[2]-ult[0];
      if(trend>0) addInsight('Tendência de alta na receita de campanhas nos últimos 3 meses.');
      else if(trend<0) addInsight('Tendência de queda na receita de campanhas nos últimos 3 meses.');
      else addInsight('Receita estável nas campanhas dos últimos 3 meses.');
    }
  }

  // Tabela Top (ordenado por ROI e receita)
  const corpo = document.querySelector('#tabelaTop tbody');
  corpo.innerHTML = '';
  const top = campanhas
    .slice()
    .sort((a,b)=> (b._roi - a._roi) || (b.receita - a.receita))
    .slice(0,6);
  top.forEach(c=>{
    const tr = document.createElement('tr');
    const roiTxt = isFinite(c._roi)? PCT(c._roi) : '—';
    const tagClass = c._roi>50 ? 'good' : (c._roi>=0 ? 'warn' : 'bad');
    tr.innerHTML = `
      <td>${c.nome}</td>
      <td>${BRL(c.receita)}</td>
      <td><span class="tag ${tagClass}">${roiTxt}</span></td>
      <td>${PCT(c.conversao)}</td>
      <td>${c.status}</td>
    `;
    corpo.appendChild(tr);
  });
}

// Carrega ao abrir
window.addEventListener('DOMContentLoaded', ()=>{
  // define mês atual no custom
  const hoje = new Date();
  const ym = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
  mesInicio.value = ym;
  mesFim.value = ym;
  carregar();
});
</script>
</body>
</html>
