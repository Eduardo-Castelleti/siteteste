<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel do Parceiro — Demo</title>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --sidebar:#2c3e50;
    --accent:#1abc9c;
    --accent-dark:#159d82;
    --muted:#7f8c8d;
    --bg:#f5f7fa;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:var(--bg);
    color:#222;
    display:flex;
    min-height:100vh;
  }

  /* SIDEBAR */
  .sidebar{
    width:260px;
    background:var(--sidebar);
    color:#fff;
    padding:22px 16px;
    position:fixed;
    top:0;left:0;bottom:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .brand{
    display:flex;flex-direction:column;align-items:center;text-align:center;
  }
  .brand img{width:96px;height:96px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.12)}
  .brand h3{margin:8px 0 2px;font-size:18px}
  .brand p{margin:0;font-size:13px;color:rgba(255,255,255,0.75)}

  .menu{width:100%;margin-top:12px;display:flex;flex-direction:column;gap:8px;}
  .menu button{
    background:transparent;border:0;color:#fff;padding:10px 12px;text-align:left;border-radius:8px;cursor:pointer;font-weight:600;
    transition:background .15s, transform .08s;
  }
  .menu button:hover{background:rgba(255,255,255,0.05);transform:translateX(4px)}
  .menu button.active{background:var(--accent);color:#043023}

  .sidebar .footer{margin-top:auto;font-size:13px;color:rgba(255,255,255,0.6)}
  .sidebar .small{font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;text-align:center}

  /* MAIN CONTENT */
  .main{
    margin-left:260px;
    padding:20px;
    width:calc(100% - 260px);
  }
  header.topbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;
  }
  header.topbar h1{margin:0;font-size:20px}
  .top-actions{display:flex;gap:8px;align-items:center}

  .card{
    background:var(--card);
    padding:14px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(18,38,63,0.06);
    margin-bottom:14px;
  }
  .grid{
    display:grid;gap:12px;
  }
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .muted{color:var(--muted);font-size:13px}

  /* Forms & tables */
  input, select, textarea{
    width:100%;padding:10px;border:1px solid #e0e6ea;border-radius:8px;margin-top:8px;font-size:14px;
    resize:vertical;background:#fff;
  }
  label{font-weight:600;font-size:13px;margin-top:8px;display:block}
  .btn{
    background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  table th, table td{padding:8px;border-bottom:1px solid #eef2f5;text-align:left;font-size:14px}
  table th{background:#f7fafb;color:#333;font-weight:700}
  .actions button{margin-right:6px}

  /* Modals */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1500}
  .modal{background:#fff;padding:18px;border-radius:10px;min-width:320px;max-width:920px;box-shadow:0 10px 30px rgba(2,6,23,0.2)}
  .modal.show{display:block}
  .right-top-cart{position:fixed;right:24px;top:24px;z-index:1600}
  .cart-btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;display:flex;gap:8px;align-items:center}
  .badge{background:#fff;color:var(--accent);padding:4px 8px;border-radius:999px;font-weight:800}

  /* calendar container */
  #calendar{background:#fff;border-radius:10px;padding:8px;box-shadow:0 6px 18px rgba(18,38,63,0.06)}

  @media (max-width:900px){
    .sidebar{display:none}
    .main{margin-left:0;width:100%;padding:12px}
    .right-top-cart{right:12px;top:12px}
  }
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="https://via.placeholder.com/200x200.png?text=Parceiro" alt="Parceiro">
      <h3 id="partnerName">Petshop Parceiro</h3>
      <p id="partnerInfo">Porto Alegre • (51) 99999-9999</p>
      <div class="small">Parceiro desde 2025</div>
    </div>

    <nav class="menu">
      <button class="active" data-section="agenda">Agenda</button>
      <button data-section="clientes">Clientes & Pets</button>
      <button data-section="resumo">Resumo</button>
      <button data-section="comunicacao">Comunicação</button>
      <button data-section="materiais">Materiais</button>
      <button data-section="servicos">Serviços (rápido)</button>
    </nav>

    <div class="footer">
      <div style="margin-top:14px;width:100%;text-align:center">
        <button class="btn ghost" onclick="alert('Abrir configurações (placeholder)')">Configurações</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <header class="topbar">
      <h1>Painel do Parceiro</h1>
      <div class="top-actions">
        <div class="muted">Olá, parceiro — acompanhe seus agendamentos e vendas</div>
      <div id="calendar"></div>
      </div>
    </header>

    <!-- Cart button -->
    <div class="right-top-cart">
      <button class="cart-btn" onclick="openCartModal()">
        Carrinho <span id="cartCount" class="badge">0</span>
      </button>
    </div>

    <!-- SECTIONS -->
    <!-- A) AGENDA -->
    <section id="agenda" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Agenda de Serviços</h2>
        <div>
          <button class="btn" onclick="openNewBookingFromService()">Novo agendamento</button>
        </div>
      </div>
      <div id="calendar" style="margin-top:12px"></div>
    </section>

    <!-- B) PEDIDOS — (Catálogo + Pedidos Recebidos) -->
    <section id="pedidos" class="card section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Catálogo de Serviços (visível no site)</h2>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="openStorePreview()">Visualizar loja</button>
          <button class="btn" onclick="switchCatalogTab('catalog')">Catálogo</button>
          <button class="btn" onclick="switchCatalogTab('orders')">Pedidos Recebidos</button>
        </div>
      </div>

      <!-- Catalog tab -->
      <div id="catalogTab" style="margin-top:12px">
        <form id="formAddService" onsubmit="event.preventDefault(); addOrUpdateService()">
          <input type="hidden" id="serviceId" />
          <label>Nome do Serviço</label>
          <input id="serviceName" required placeholder="Banho completo, Tosa higiênica..." />
          <label>Descrição</label>
          <textarea id="serviceDesc" rows="2" placeholder="Descrição curta"></textarea>
          <div style="display:grid;grid-template-columns:1fr 140px 140px;gap:10px">
            <div>
              <label>Preço (R$)</label>
              <input id="servicePrice" type="number" step="0.01" required />
            </div>
            <div>
              <label>Duração (min)</label>
              <input id="serviceDuration" type="number" min="10" step="5" required />
            </div>
            <div>
              <label>Publicado?</label>
              <select id="servicePublished">
                <option value="true">Sim</option>
                <option value="false">Não</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" type="submit">Salvar serviço</button>
            <button class="btn ghost" type="button" onclick="resetServiceForm()">Limpar</button>
          </div>
        </form>

        <h3 style="margin-top:14px">Serviços cadastrados</h3>
        <table id="servicesTable">
          <thead><tr><th>Nome</th><th>Preço</th><th>Duração</th><th>Publicado</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Orders tab -->
      <div id="ordersTab" style="margin-top:12px;display:none">
        <h3>Pedidos Recebidos</h3>
        <table id="ordersTable">
          <thead><tr><th>ID</th><th>Cliente</th><th>Itens</th><th>Data/Hora</th><th>Total</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- C) CLIENTES & PETS -->
    <section id="clientes" class="card section" style="display:none">
      <h2>Clientes & Pets</h2>
      <form id="formClientes" onsubmit="event.preventDefault(); addClient()">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Nome do Cliente</label>
            <input id="clienteNome" required />
          </div>
          <div>
            <label>Telefone</label>
            <input id="clienteTelefone" required />
          </div>
          <div>
            <label>Nome do Pet</label>
            <input id="petNome" required />
          </div>
          <div>
            <label>Espécie</label>
            <input id="petEspecie" required />
          </div>
          <div>
            <label>Raça</label>
            <input id="petRaca" />
          </div>
          <div>
            <label>Idade (anos)</label>
            <input id="petIdade" type="number" min="0" />
          </div>
          <div>
            <label>Peso (kg)</label>
            <input id="petPeso" type="number" step="0.1" />
          </div>
        </div>
        <div style="margin-top:10px"><button class="btn" type="submit">Salvar cliente</button></div>
      </form>

      <h3 style="margin-top:10px">Clientes Cadastrados</h3>
      <table id="clientsTable">
        <thead><tr><th>Cliente</th><th>Telefone</th><th>Pet</th><th>Espécie</th><th>Raça</th><th>Idade</th><th>Peso</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- D) RESUMO -->
    <section id="resumo" class="card section" style="display:none">
      <h2>Resumo</h2>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <h4>Vendas (últimos 6 meses)</h4>
          <canvas id="chartSales" height="160"></canvas>
        </div>
        <div class="card">
          <h4>Agendamentos por serviço</h4>
          <canvas id="chartServices" height="160"></canvas>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:12px">
        <div class="card">
          <h4>Total de pedidos</h4>
          <div id="statTotalOrders" style="font-size:22px;font-weight:800;margin-top:6px">0</div>
        </div>
        <div class="card">
          <h4>Clientes ativos</h4>
          <div id="statClients" style="font-size:22px;font-weight:800;margin-top:6px">0</div>
        </div>
        <div class="card">
          <h4>Ticket médio</h4>
          <div id="statTicket" style="font-size:22px;font-weight:800;margin-top:6px">R$ 0,00</div>
        </div>
      </div>
    </section>

    <!-- E) COMUNICAÇÃO -->
    <section id="comunicacao" class="card section" style="display:none">
      <h2>Comunicação</h2>
      <p class="muted">Área para troca rápida de mensagens. (Placeholder)</p>
      <textarea id="msgText" rows="4" placeholder="Escreva uma mensagem para a loja/parceiro..."></textarea>
      <div style="margin-top:8px"><button class="btn" onclick="alert('Mensagem enviada (placeholder)')">Enviar</button></div>
    </section>

    <!-- F) MATERIAIS -->
    <section id="materiais" class="card section" style="display:none">
      <h2>Materiais de Marketing</h2>
      <p class="muted">Banners, posts para redes e textos para WhatsApp.</p>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn ghost" onclick="alert('Baixar material (placeholder)')">Baixar banner</button>
        <button class="btn ghost" onclick="alert('Copiar texto (placeholder)')">Copiar texto WhatsApp</button>
      </div>
    </section>

    <!-- G) Serviços (atalho) -->
    <section id="servicos" class="card section" style="display:none">
      <h2>Serviços (atalho)</h2>
      <p class="muted">Acesso rápido ao catálogo de serviços.</p>
      <div style="margin-top:8px">
        <button class="btn" onclick="switchCatalogTab('catalog'); showSection('pedidos')">Ir para Catálogo</button>
      </div>
    </section>

  </main>

  <!-- MODAIS -->
  <div id="backdrop" class="modal-backdrop"></div>

  <!-- Loja (preview público) -->
  <div id="modalStore" class="modal-backdrop">
    <div class="modal">
      <h3>Loja — serviços publicados</h3>
      <div id="storeList"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeStorePreview()">Fechar</button>
        <button class="btn" onclick="openCartModal()">Ver carrinho</button>
      </div>
    </div>
  </div>

  <!-- Cart -->
  <div id="modalCart" class="modal-backdrop">
    <div class="modal">
      <h3>Carrinho</h3>
      <div id="cartItems"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:space-between;align-items:center">
        <div class="muted" id="cartTotalLabel">Total: R$ 0,00</div>
        <div>
          <button class="btn ghost" onclick="closeCartModal()">Fechar</button>
          <button class="btn" onclick="openCheckoutModal()">Finalizar / Agendar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout -->
  <div id="modalCheckout" class="modal-backdrop">
    <div class="modal">
      <h3>Finalizar e agendar</h3>
      <div style="display:grid;gap:8px">
        <label>Nome do cliente</label><input id="checkoutName" />
        <label>Telefone</label><input id="checkoutPhone" />
        <label>Pet (opcional)</label><input id="checkoutPet" />
        <label>Data</label><input id="checkoutDate" type="date" />
        <label>Hora</label><input id="checkoutTime" type="time" />
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeCheckoutModal()">Cancelar</button>
        <button class="btn" onclick="confirmCheckout()">Confirmar e agendar</button>
      </div>
    </div>
  </div>

  <!-- Event status modal -->
  <div id="modalStatusEvento" class="modal-backdrop">
    <div class="modal">
      <div id="modalStatusContent"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeStatusModal()">Fechar</button>
      </div>
    </div>
  </div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
/* ============================
   DADOS INICIAIS (memória)
   ============================ */
let services = [
  { id: genId(), name: 'Banho completo', desc:'Banho, secagem e perfume', price: 70.00, duration: 45, published:true },
  { id: genId(), name: 'Tosa higiênica', desc:'Aparar áreas higiênicas', price: 45.00, duration: 30, published:true },
];

let clients = []; // cliente objects
let orders = [];  // pedidos gerados via checkout
let cart = [];    // {serviceId, qty}
let calendar;     // fullcalendar instance

/* ============================
   UTILIDADES
   ============================ */
function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function money(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

/* ============================
   INITIAL UI HOOKS
   ============================ */
document.addEventListener('DOMContentLoaded', function(){

  // Menu buttons
  document.querySelectorAll('.menu button').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      showSection( btn.dataset.section );
      // if pedios/servicos clicked show catalog
      if(btn.dataset.section === 'servicos'){ switchCatalogTab('catalog'); showSection('pedidos') }
    });
  });

  // initialize sections content
  renderServicesTable();
  renderClientsTable();
  renderOrdersTable();
  updateStats();
  renderStoreList();
  updateCartCount();

  // init calendar
  initCalendar();

  // init charts
  initCharts();

  // hide modals initially
  closeAllModals();
});

/* ============================
   SECTION NAV
   ============================ */
function showSection(id){
  document.querySelectorAll('.section').forEach(s=> s.style.display='none');
  const el = document.getElementById(id);
  if(el) el.style.display = 'block';
}

/* ============================
   SERVICES (Catálogo / Pedidos)
   ============================ */
function addOrUpdateService(){
  const id = document.getElementById('serviceId').value;
  const name = document.getElementById('serviceName').value.trim();
  const desc = document.getElementById('serviceDesc').value.trim();
  const price = parseFloat(document.getElementById('servicePrice').value || 0);
  const duration = parseInt(document.getElementById('serviceDuration').value || 0,10);
  const published = document.getElementById('servicePublished').value === 'true';

  if(!name || !price) { alert('Nome e preço são obrigatórios'); return; }

  if(id){
    // update
    const s = services.find(x=>x.id===id);
    if(s){ Object.assign(s,{name,desc,price,duration,published}); }
  } else {
    services.push({ id: genId(), name, desc, price, duration, published });
  }
  resetServiceForm();
  renderServicesTable();
  renderStoreList();
  updateChartsAndStats();
  alert('Serviço salvo!');
}

function resetServiceForm(){
  document.getElementById('serviceId').value='';
  document.getElementById('serviceName').value='';
  document.getElementById('serviceDesc').value='';
  document.getElementById('servicePrice').value='';
  document.getElementById('serviceDuration').value='';
  document.getElementById('servicePublished').value='true';
}

function renderServicesTable(){
  const tbody = document.querySelector('#servicesTable tbody');
  tbody.innerHTML='';
  services.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${s.name}</strong><div class="muted" style="font-weight:400">${s.desc||''}</div></td>
      <td>${money(s.price)}</td>
      <td>${s.duration} min</td>
      <td>${s.published? 'Sim' : 'Não'}</td>
      <td class="actions">
        <button class="btn ghost" onclick="editService('${s.id}')">Editar</button>
        <button class="btn" onclick="togglePublish('${s.id}')">${s.published? 'Despublicar' : 'Publicar'}</button>
        <button class="btn ghost" onclick="deleteService('${s.id}')">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editService(id){
  const s = services.find(x=>x.id===id); if(!s) return;
  document.getElementById('serviceId').value = s.id;
  document.getElementById('serviceName').value = s.name;
  document.getElementById('serviceDesc').value = s.desc;
  document.getElementById('servicePrice').value = s.price;
  document.getElementById('serviceDuration').value = s.duration;
  document.getElementById('servicePublished').value = s.published ? 'true' : 'false';
  window.scrollTo({top:0,behavior:'smooth'});
}

function togglePublish(id){
  const s = services.find(x=>x.id===id); if(!s) return;
  s.published = !s.published;
  renderServicesTable();
  renderStoreList();
  updateChartsAndStats();
}

function deleteService(id){
  if(!confirm('Excluir este serviço?')) return;
  services = services.filter(s=>s.id!==id);
  renderServicesTable();
  renderStoreList();
  updateChartsAndStats();
}

/* ============================
   Loja / Carrinho / Checkout
   ============================ */
function renderStoreList(){
  const el = document.getElementById('storeList');
  if(!el) return;
  const published = services.filter(s=>s.published);
  if(published.length===0){
    el.innerHTML = '<p class="muted">Nenhum serviço publicado.</p>';
    return;
  }
  el.innerHTML = published.map(s=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f2f3">
      <div>
        <strong>${s.name}</strong>
        <div class="muted">${s.desc||''}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${money(s.price)}</div>
        <button class="btn" style="margin-top:8px" onclick="addToCart('${s.id}')">Adicionar ao carrinho</button>
      </div>
    </div>
  `).join('');
}

function openStorePreview(){
  document.getElementById('modalStore').style.display='flex';
  renderStoreList();
}
function closeStorePreview(){ document.getElementById('modalStore').style.display='none'; }

function addToCart(serviceId){
  const item = cart.find(i=>i.serviceId===serviceId);
  if(item) item.qty++;
  else cart.push({ serviceId, qty:1 });
  updateCartCount();
  renderStoreList();
  alert('Adicionado ao carrinho!');
}

function updateCartCount(){
  const c = cart.reduce((s,i)=>s+i.qty,0);
  document.getElementById('cartCount').textContent = c;
}

function openCartModal(){
  const modal = document.getElementById('modalCart');
  modal.style.display='flex';
  renderCartItems();
333333333333333333333333333333333333}
function closeCartModal(){ document.getElementById('modalCart').style.display='none'; }

function renderCartItems(){
  const el = document.getElementById('cartItems'); el.innerHTML='';
  if(cart.length===0){ el.innerHTML = '<p class="muted">Carrinho vazio.</p>'; document.getElementById('cartTotalLabel').textContent='Total: R$ 0,00'; return; }
  let html = '<table><thead><tr><th>Serviço</th><th>Qtd</th><th>Preço</th><th>Ações</th></tr></thead><tbody>';
  let total = 0;
  cart.forEach(ci=>{
    const s = services.find(x=>x.id===ci.serviceId);
    const line = (s ? s.price*ci.qty : 0);
    total += line;
    html += `<tr><td>${s? s.name : '—'}</td><td>${ci.qty}</td><td>${money(line)}</td><td>
      <button class="btn ghost" onclick="changeQty('${ci.serviceId}',1)">+</button>
      <button class="btn ghost" onclick="changeQty('${ci.serviceId}',-1)">-</button>
    </td></tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
  document.getElementById('cartTotalLabel').textContent = 'Total: ' + money(total);
  updateCartCount();
}

function changeQty(serviceId, delta){
  const idx = cart.findIndex(i=>i.serviceId===serviceId);
  if(idx===-1) return;
  cart[idx].qty += delta;
  if(cart[idx].qty<=0) cart.splice(idx,1);
  renderCartItems();
  updateCartCount();
}

function openCheckoutModal(){ 
  if(cart.length===0){ alert('Carrinho vazio'); return; }
  closeCartModal();
  document.getElementById('modalCheckout').style.display='flex';
}
function closeCheckoutModal(){ document.getElementById('modalCheckout').style.display='none'; }

function confirmCheckout(){
  const name = document.getElementById('checkoutName').value.trim();
  const phone = document.getElementById('checkoutPhone').value.trim();
  const pet = document.getElementById('checkoutPet').value.trim();
  const date = document.getElementById('checkoutDate').value;
  const time = document.getElementById('checkoutTime').value;

  if(!name || !phone || !date || !time){ alert('Preencha nome, telefone, data e hora'); return; }

  // build order
  const items = cart.map(ci=>({serviceId:ci.serviceId, qty:ci.qty}));
  let total = 0;
  items.forEach(it=>{
    const s = services.find(x=>x.id===it.serviceId);
    if(s) total += s.price * it.qty;
  });

  const order = {
    id: genId(),
    items,
    clientName: name,
    phone,
    petName: pet,
    datetime: date + 'T' + time,
    total,
    status: 'pendente'
  };
  orders.push(order);

  // add event to calendar
  const firstService = services.find(s=>s.id === items[0].serviceId);
  const title = firstService ? `${firstService.name} - ${pet || name}` : `Serviço - ${pet || name}`;
  calendar.addEvent({ id: order.id, title, start: order.datetime, allDay:false, extendedProps:{orderId: order.id, status:'pendente'} });

  // clear cart and close
  cart = [];
  updateCartCount();
  closeCheckoutModal();

  // refresh orders list and summary
  renderOrdersTable();
  updateChartsAndStats();

  alert('Pedido criado e agendamento adicionado à agenda!');
}

/* ============================
   Orders rendering
   ============================ */
function renderOrdersTable(){
  const tbody = document.querySelector('#ordersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  orders.slice().reverse().forEach(o=>{
    const itemsHtml = o.items.map(it=>{
      const s = services.find(x=>x.id===it.serviceId);
      return `${s? s.name : '—'} x${it.qty}`;
    }).join('<br>');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id}</td><td>${o.clientName}</td><td>${itemsHtml}</td><td>${new Date(o.datetime).toLocaleString()}</td><td>${money(o.total)}</td><td>${o.status}</td>`;
    tbody.appendChild(tr);
  });
}

/* ============================
   CLIENTS
   ============================ */
function addClient(){
  const name = document.getElementById('clienteNome').value.trim();
  const phone = document.getElementById('clienteTelefone').value.trim();
  const pet = document.getElementById('petNome').value.trim();
  const specie = document.getElementById('petEspecie').value.trim();
  const breed = document.getElementById('petRaca').value.trim();
  const age = document.getElementById('petIdade').value;
  const weight = document.getElementById('petPeso').value;
  if(!name || !phone || !pet){ alert('Preencha nome, telefone e nome do pet'); return; }
  clients.push({ id: genId(), name, phone, pet, specie, breed, age, weight });
  renderClientsTable();
  document.getElementById('formClientes').reset();
  updateChartsAndStats();
  alert('Cliente salvo!');
}

function renderClientsTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  clients.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${c.phone}</td><td>${c.pet}</td><td>${c.specie}</td><td>${c.breed||'-'}</td><td>${c.age||'-'}</td><td>${c.weight||'-'}</td>`;
    tbody.appendChild(tr);
  });
}

/* ============================
   CALENDAR (FullCalendar)
   ============================ */
function initCalendar(){
  const calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
    locale: 'pt-br',
    events: [], // start empty, orders will add
    eventClick: function(info){
      openStatusModal(info.event);
    },
    eventDidMount: function(info){
      const status = info.event.extendedProps.status || 'pendente';
      let bg = '#3788d8';
      if(status==='confirmado') bg = '#2a9d8f';
      else if(status==='realizado') bg = '#6a994e';
      else if(status==='cancelado') bg = '#d62828';
      info.el.style.backgroundColor = bg;
      info.el.style.borderColor = bg;
    }
  });
  calendar.render();
}

/* Open modal for event status actions */
function openStatusModal(event){
  const modal = document.getElementById('modalStatusEvento');
  const content = document.getElementById('modalStatusContent');
  const orderId = event.extendedProps.orderId;
  const order = orders.find(o=>o.id===orderId) || null;

  content.innerHTML = `
    <h3>${event.title}</h3>
    <p class="muted">Agendado: ${new Date(event.start).toLocaleString()}</p>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
      <button class="btn" onclick="changeEventStatus('${event.id}','confirmado')">Confirmar banho</button>
      <button class="btn" onclick="changeEventStatus('${event.id}','realizado')">Banho realizado</button>
      <button class="btn" style="background:#d62828" onclick="changeEventStatus('${event.id}','cancelado')">Cancelar banho</button>
    </div>
    ${order ? `<div style="margin-top:12px"><strong>Pedido:</strong> ${order.id} • ${money(order.total)}</div>` : ''}
  `;
  modal.style.display='flex';
}

function closeStatusModal(){ document.getElementById('modalStatusEvento').style.display='none'; }

function changeEventStatus(eventId, status){
  const ev = calendar.getEventById(eventId);
  if(!ev) { alert('Evento não encontrado'); return; }
  ev.setExtendedProp('status', status);

  // update related order if exists
  const order = orders.find(o=>o.id === ev.extendedProps.orderId);
  if(order){ order.status = status; renderOrdersTable(); }

  // update title suffix
  let base = ev.title.split(' - ')[0];
  if(status==='confirmado') base += ' - Confirmado';
  if(status==='realizado') base += ' - Realizado';
  if(status==='cancelado') base += ' - Cancelado';
  ev.setProp('title', base);

  calendar.refetchEvents();
  closeStatusModal();
}

/* ============================
   New booking (partner manual)
   ============================ */
function openNewBookingFromService(){
  // open store preview so partner can select a service as base for booking
  openStorePreview();
  // store will let partner add to cart and then checkout to create booking OR we can implement a quick dialog
}

/* ============================
   CART / ORDER helpers
   ============================ */
function closeAllModals(){
  document.querySelectorAll('.modal-backdrop').forEach(m => m.style.display='none');
}

/* ============================
   STATS & CHARTS (Chart.js)
   ============================ */
let chartSales = null;
let chartServices = null;

function initCharts(){
  const ctx1 = document.getElementById('chartSales').getContext('2d');
  chartSales = new Chart(ctx1, {
    type:'bar',
    data:{ labels:[], datasets:[{ label:'Vendas (R$)', data:[], backgroundColor: '#1abc9c' }]},
    options:{ responsive:true, plugins:{legend:{display:false}}}
  });

  const ctx2 = document.getElementById('chartServices').getContext('2d');
  chartServices = new Chart(ctx2, {
    type:'doughnut',
    data:{ labels:[], datasets:[{ data:[], backgroundColor: ['#1abc9c','#2ecc71','#f39c12','#e74c3c','#3498db','#9b59b6']}]},
    options:{ responsive:true }
  });

  updateChartsAndStats();
}

function updateChartsAndStats(){
  // SALES last 6 months from orders
  const months = []; const sales = [];
  const now = new Date();
  for(let i=5;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const key = d.toLocaleString('pt-BR',{month:'short', year:'numeric'});
    months.push(key);
    // sum orders in that month
    const total = orders.reduce((s,o)=>{
      const od = new Date(o.datetime);
      return (od.getFullYear()===d.getFullYear() && od.getMonth()===d.getMonth()) ? s + o.total : s;
    },0);
    sales.push( Math.round(total) );
  }

  chartSales.data.labels = months;
  chartSales.data.datasets[0].data = sales;
  chartSales.update();

  // Services chart — count orders per service
  const serviceCounts = {};
  orders.forEach(o=>{
    o.items.forEach(it=>{
      serviceCounts[it.serviceId] = (serviceCounts[it.serviceId] || 0) + it.qty;
    });
  });
  const labels = [];
  const data = [];
  Object.keys(serviceCounts).forEach(id=>{
    const s = services.find(x=>x.id===id);
    labels.push(s ? s.name : '—');
    data.push(serviceCounts[id]);
  });
  // if no data show placeholder
  if(labels.length===0){ labels.push('Sem dados'); data.push(1); }

  chartServices.data.labels = labels;
  chartServices.data.datasets[0].data = data;
  chartServices.update();

  // stats
  document.getElementById('statTotalOrders').textContent = orders.length;
  document.getElementById('statClients').textContent = clients.length;
  const avg = orders.length ? orders.reduce((s,o)=>s+o.total,0) / orders.length : 0;
  document.getElementById('statTicket').textContent = money(avg.toFixed(2));
}

/* ============================
   Orders Tab helper
   ============================ */
function switchCatalogTab(tab){
  document.getElementById('catalogTab').style.display = (tab==='catalog' ? 'block' : 'none');
  document.getElementById('ordersTab').style.display = (tab==='orders' ? 'block' : 'none');
}

/* ============================
   Helper functions for actions
   ============================ */
function editServiceFromList(id){
  editService(id);
  showSection('pedidos');
  switchCatalogTab('catalog');
}

function deleteServiceFromList(id){
  if(confirm('Excluir serviço?')) { deleteService(id); renderServicesTable(); renderStoreList(); }
}

/* ============================
   Small helpers to wire UI
   ============================ */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

/* ============================
   On-the-fly functions used from HTML attributes
   ============================ */
function openCartModal(){ openCartModal(); } // placeholder to avoid console errors

// Expose a few functions to global scope for inline onclicks
window.openStorePreview = openStorePreview;
window.closeStorePreview = closeStorePreview;
window.addToCart = addToCart;
window.openCartModal = openCartModal;
window.closeCartModal = closeCartModal;
window.openCheckoutModal = openCheckoutModal;
window.closeCheckoutModal = closeCheckoutModal;
window.confirmCheckout = confirmCheckout;
window.switchCatalogTab = switchCatalogTab;
window.editService = editService;
window.deleteService = deleteService;
window.togglePublish = togglePublish;
window.openNewBookingFromService = openNewBookingFromService;
window.changeEventStatus = changeEventStatus;
window.closeStatusModal = closeStatusModal;
window.resetServiceForm = resetServiceForm;
window.openModal = openModal;
window.closeModal = closeModal;
window.renderOrdersTable = renderOrdersTable;
window.updateChartsAndStats = updateChartsAndStats;
window.renderServicesTable = renderServicesTable;
window.renderClientsTable = renderClientsTable;
window.renderStoreList = renderStoreList;
window.renderCartItems = renderCartItems;
window.updateCartCount = updateCartCount;

</script>
</body>
</html>
