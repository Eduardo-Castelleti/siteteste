<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Pet - Clientes</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #f4f6f9;
    }
    /* Menu lateral */
    .sidebar {
      width: 250px;
      background-color: #2c3e50;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
    }
    .sidebar h2 { text-align:center; margin-bottom:30px; font-size:20px; font-weight:700; }
    .sidebar a { padding:15px 20px; text-decoration:none; color:#ecf0f1; display:block; transition:0.3s; font-weight:500; }
    .sidebar a:hover { background-color: #34495e; }
    .sidebar a.active { background-color:#1abc9c; color:#fff; }
    .content { flex:1; padding:20px; overflow-y:auto; }
    h1 { font-size:24px; margin-bottom:20px; color:#2c3e50; }

    /* Cards */
    .cards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card h3 { margin: 0; font-size: 18px; color: #555; }
    .card p { font-size: 22px; margin: 5px 0 0; font-weight: bold; }

    /* Bot√£o */
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #2980b9; }

    /* Tabela */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th { background: #f8f9fa; }
    tr:hover { background: #f1f1f1; cursor: pointer; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .close {
      cursor: pointer;
      font-size: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label { display: block; margin-bottom: 5px; }
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Colaborador</h2>
    <a href="index.html" class="active">üì¶ Pedidos</a>
    <a href="clientes.html">üë• Clientes</a>
    <a href="parceiros.html">ü§ù Parceiros</a>
    <a href="produtos.html">üõí Produtos</a>
    <a href="agenda.html">üìÖ Agenda</a>
    <a href="marketing.html">üì¢ Marketing</a>
    <a href="kpi.html">üìä KPI‚Äôs</a>
  </div>

  <!-- Conte√∫do -->
  <div class="content">
    <h1>Clientes</h1>

    <!-- Cards -->
    <div class="cards">
      <div class="card">
        <h3>Clientes que compraram no m√™s</h3>
        <p id="clientesCompraram">0</p>
      </div>
      <div class="card">
        <h3>Total de Clientes</h3>
        <p id="totalClientes">0</p>
      </div>
      <div class="card">
        <h3>Ativos</h3>
        <p id="clientesAtivos">0</p>
      </div>
      <div class="card">
        <h3>Inativos</h3>
        <p id="clientesInativos">0</p>
      </div>
    </div>

    <button onclick="openModal()">+ Cadastrar Cliente</button>

    <!-- Tabela -->
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Telefone</th>
          <th>Email</th>
          <th>CPF</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="listaClientes">
      </tbody>
    </table>
  </div>

  <!-- Modal Cadastro -->
  <div class="modal" id="modalCliente">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Cadastrar Cliente</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="form-group">
        <label>Nome</label>
        <input type="text" id="nome">
      </div>
      <div class="form-group">
        <label>Telefone</label>
        <input type="text" id="telefone">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email">
      </div>
      <div class="form-group">
        <label>CPF</label>
        <input type="text" id="cpf">
      </div>
      <div class="form-group">
        <label>Data de Nascimento</label>
        <input type="date" id="nascimento">
      </div>
      <button onclick="salvarCliente()">Salvar</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLBni8BY6zjHGMuoybZ06SBK4U9c1BhyE",
      authDomain: "petdudis-db2b2.firebaseapp.com",
      projectId: "petdudis-db2b2",
      storageBucket: "petdudis-db2b2.firebasestorage.app",
      messagingSenderId: "410321083813",
      appId: "1:410321083813:web:eaf0082878a8281eab5c4c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Abrir/Fechar Modal
    window.openModal = () => document.getElementById('modalCliente').style.display = 'flex';
    window.closeModal = () => document.getElementById('modalCliente').style.display = 'none';

    // Salvar Cliente com verifica√ß√£o de duplicidade
    window.salvarCliente = async () => {
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const nascimento = document.getElementById('nascimento').value;

      if(!nome || !telefone) {
        alert("Preencha os campos obrigat√≥rios!");
        return;
      }

      try {
        // Verifica telefone duplicado
        const qTelefone = query(collection(db, "clientes"), where("telefone", "==", telefone));
        const snapshotTelefone = await getDocs(qTelefone);
        if(!snapshotTelefone.empty) {
          alert("J√° existe um cliente cadastrado com este telefone!");
          return;
        }

        // Verifica email duplicado
        if(email) {
          const qEmail = query(collection(db, "clientes"), where("email", "==", email));
          const snapshotEmail = await getDocs(qEmail);
          if(!snapshotEmail.empty) {
            alert("J√° existe um cliente cadastrado com este email!");
            return;
          }
        }

        await addDoc(collection(db, "clientes"), {
          nome,
          telefone,
          email,
          cpf,
          nascimento,
          status: "Ativo",
          createdAt: new Date()
        });

        alert("Cliente cadastrado com sucesso!");
        closeModal();

      } catch (error) {
        console.error("Erro ao salvar cliente: ", error);
        alert("Erro ao salvar cliente. Confira o console.");
      }
    };

    // Listar clientes em tempo real
    const listaClientes = document.getElementById("listaClientes");
    const totalClientes = document.getElementById("totalClientes");
    const clientesAtivos = document.getElementById("clientesAtivos");
    const clientesInativos = document.getElementById("clientesInativos");

    onSnapshot(collection(db, "clientes"), (snapshot) => {
      listaClientes.innerHTML = "";
      let ativos = 0, inativos = 0;

      snapshot.forEach((doc) => {
        const cliente = doc.data();
        if(cliente.status === "Ativo") ativos++;
        else inativos++;

        listaClientes.innerHTML += `
          <tr>
            <td>${cliente.nome}</td>
            <td>${cliente.telefone}</td>
            <td>${cliente.email || "-"}</td>
            <td>${cliente.cpf || "-"}</td>
            <td>${cliente.status}</td>
          </tr>
        `;
      });

      totalClientes.textContent = snapshot.size;
      clientesAtivos.textContent = ativos;
      clientesInativos.textContent = inativos;
    });

// --- CARD: Clientes que compraram no m√™s ---
async function contarClientesCompraramMes() {
  const agora = new Date();
  const primeiroDia = new Date(agora.getFullYear(), agora.getMonth(), 1);
  const ultimoDia = new Date(agora.getFullYear(), agora.getMonth() + 1, 0);

  try {
    // consulta no Firestore (cole√ß√£o "clientes")
    const q = query(
      collection(db, "clientes"),
      where("ultimaCompra", ">=", primeiroDia),
      where("ultimaCompra", "<=", ultimoDia)
    );

    const snapshot = await getDocs(q);
    document.getElementById("clientesCompraram").textContent = snapshot.size;
  } catch (error) {
    console.error("Erro ao contar clientes:", error);
  }
}

// chama a fun√ß√£o quando carregar
contarClientesCompraramMes();

</script>

</body>
</html>
