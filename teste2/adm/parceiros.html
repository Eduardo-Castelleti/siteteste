<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Pet - Parceiros</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family: 'Roboto', sans-serif;}
body {display:flex; min-height:100vh; background:#f4f6f9;}
.sidebar {width:260px; background:#2c3e50; color:#ecf0f1; flex-shrink:0; display:flex; flex-direction:column;}
.sidebar h2 {text-align:center; padding:20px 0; border-bottom:1px solid #34495e;}
.sidebar a {padding:15px 25px; display:flex; align-items:center; color:#ecf0f1; text-decoration:none; border-bottom:1px solid #34495e; transition:0.3s;}
.sidebar a:hover {background:#34495e;}
.sidebar a i {margin-right:15px;}
.badge {background:#e74c3c; color:white; border-radius:12px; padding:2px 8px; font-size:12px; margin-left:auto;}
.main-content {flex:1; padding:20px; overflow-y:auto;}
h1 {margin-bottom:20px; color:#2c3e50;}
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px;}
.card {padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); color:white; position:relative; transition:0.3s;}
.card h3 {margin-bottom:10px; font-size:18px;}
.card p {font-size:24px; font-weight:700;}
.card.total {background:#2980b9;}
.card.vip {background:#16a085;}
.card.novos {background:#f39c12;}
.card.emergentes {background:#8e44ad;}
.card.alertaVIP {background:#c0392b;}
.card.alerta {box-shadow:0 0 15px 3px rgba(255,0,0,0.5);}
.graph {height:300px; background:#ecf0f1; border-radius:10px; display:flex; justify-content:center; align-items:center; color:#7f8c8d; font-size:18px; margin-bottom:30px; padding:10px;}
canvas {background:#fff; border-radius:10px; padding:10px;}
button {padding:10px 20px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; transition:0.3s;}
button:hover {background:#3498db;}
.top-bar {display:flex; justify-content:flex-end; margin-bottom:20px;}

/* ====== Modal ====== */
.modal {display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;}
.modal-content {background:#fff; width:95%; max-width:900px; max-height:92vh; overflow:auto; border-radius:10px; padding:20px;}
.modal-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
.close {background:#c0392b; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;}
.nav-tabs {display:flex; border-bottom:1px solid #ddd; margin:6px 0 16px;}
.nav-tabs button {flex:1; padding:10px; background:#ecf0f1; border:none; cursor:pointer;}
.nav-tabs button.active {background:#2980b9; color:#fff;}
.tab {display:none;}
.tab.active {display:block;}
.form-grid {display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px;}
.input, .select, .textarea {width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;}
.section-title {margin:10px 0 6px; color:#2c3e50;}
.checkline {display:flex; flex-wrap:wrap; gap:12px; margin-top:6px;}
.footer-actions {display:flex; justify-content:flex-end; gap:10px; margin-top:16px;}
</style>
</head>
<body>

<div class="sidebar">
<h2>Admin Pet</h2>
<a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="clientes.html"><i class="fas fa-user"></i> Clientes</a>
<a href="parceiros.html"><i class="fas fa-building"></i> Parceiros</a>
<a href="funcionarios.html"><i class="fas fa-users"></i> Funcionários</a>
<a href="produtos.html"><i class="fas fa-box"></i> Produtos</a>
<a href="agendamentos.html"><i class="fas fa-calendar-alt"></i> Agendamentos</a>
<a href="vendas.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
<a href="financeiro.html"><i class="fas fa-wallet"></i> Financeiro</a>
<a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing / Promoções</a>
<a href="relatorios.html"><i class="fas fa-chart-line"></i> Relatórios / Resumos</a>
<a href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a>
<a href="feedback.html"><i class="fas fa-comment-dots"></i> Feedback / Reclamações</a>
<a href="notificacoes.html"><i class="fas fa-bell"></i> Notificações <span class="badge">3</span></a>
</div>

<div class="main-content">
<h1>Parceiros</h1>

<div class="top-bar">
  <button onclick="abrirModal()"><i class="fas fa-plus"></i> Cadastrar Parceiro</button>
</div>

<div class="cards">
  <div class="card total"><h3>Total de Parceiros</h3><p id="totalParceiros">0</p></div>
  <div class="card vip"><h3>Parceiros VIP</h3><p id="parceirosVIP">0</p></div>
  <div class="card novos"><h3>Novos Parceiros (Último Mês)</h3><p id="novosParceiros">0</p></div>
  <div class="card emergentes"><h3>Parceiros Emergentes</h3><p id="emergentesParceiros">0</p></div>
  <div class="card alertaVIP"><h3>Próximos VIPs</h3><p id="proximosVIPs">0</p></div>
</div>

<div class="graph"><canvas id="graficoCategorias"></canvas></div>
<div class="graph"><canvas id="graficoCrescimento"></canvas></div>
</div>

<!-- ====== MODAL ====== -->
<div class="modal" id="modalParceiro">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Novo Parceiro</h2>
      <button class="close" onclick="fecharModal()">Fechar</button>
    </div>

    <div class="nav-tabs">
      <button class="tabBtn active" data-tab="tab-empresa">Empresa</button>
      <button class="tabBtn" data-tab="tab-servicos">Serviços</button>
      <button class="tabBtn" data-tab="tab-responsavel">Responsável</button>
      <button class="tabBtn" data-tab="tab-financeiro">Financeiro</button>
    </div>

    <form id="formParceiro">
      <div class="tab active" id="tab-empresa">
        <div class="section-title">Dados da Empresa</div>
        <div class="form-grid">
          <input class="input" id="nomeEmpresa" placeholder="Nome da Empresa *" required>
          <input class="input" id="cnpjCpf" placeholder="CNPJ / CPF *" required>
          <input class="input" id="telefoneEmpresa" placeholder="Telefone">
          <input class="input" id="website" placeholder="Website / Redes sociais">
        </div>
        <div class="section-title" style="margin-top:10px;">Endereço</div>
        <div class="form-grid">
          <input class="input" id="cep" placeholder="CEP *" maxlength="9" onblur="buscarCEP()" required>
          <input class="input" id="rua" placeholder="Rua">
          <input class="input" id="numero" placeholder="Número">
          <input class="input" id="bairro" placeholder="Bairro">
          <input class="input" id="cidade" placeholder="Cidade">
          <input class="input" id="estado" placeholder="Estado">
        </div>
      </div>

      <div class="tab" id="tab-servicos">
        <div class="section-title">Serviços oferecidos (marque quantos quiser)</div>
        <div class="checkline">
          <label><input type="checkbox" id="srvBanhoTosa"> Banho & Tosa</label>
          <label><input type="checkbox" id="srvCreche"> Creche</label>
          <label><input type="checkbox" id="srvHospedagem"> Hospedagem</label>
          <label><input type="checkbox" id="srvDogWalker"> Dog Walker</label>
          <label><input type="checkbox" id="srvPetSitter"> Pet Sitter</label>
          <label><input type="checkbox" id="srvAdestramento"> Adestramento</label>
          <label><input type="checkbox" id="srvOutros"> Outros</label>
        </div>
        <input class="input" id="descricaoOutros" placeholder="Descrever outros serviços (opcional)">
      </div>

      <div class="tab" id="tab-responsavel">
        <div class="section-title">Responsável</div>
        <div class="form-grid">
          <input class="input" id="respNome" placeholder="Nome *">
          <input class="input" id="respTelefone" placeholder="Telefone *">
          <input class="input" id="respEmail" type="email" placeholder="E-mail *">
          <input class="input" id="respCargo" placeholder="Cargo / Função">
        </div>
      </div>

      <div class="tab" id="tab-financeiro">
        <div class="section-title">Financeiro</div>
        <div class="form-grid">
          <input class="input" id="faixaFaturamento" placeholder="Faixa de Faturamento">
          <input class="input" id="formasPagamento" placeholder="Formas de pagamento">
          <input class="input" id="limiteCredito" placeholder="Limite de Crédito">
          <select class="select" id="statusParceiro">
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
          </select>
        </div>
        <textarea class="textarea" id="observacoes" rows="3" placeholder="Observações"></textarea>
      </div>

      <div class="footer-actions">
        <button type="button" onclick="fecharModal()">Cancelar</button>
        <button type="submit"><i class="fas fa-save"></i> Salvar Parceiro</button>
      </div>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLBni8BY6zjHGMuoybZ06SBK4U9c1BhyE",
  authDomain: "petdudis-db2b2.firebaseapp.com",
  projectId: "petdudis-db2b2",
  storageBucket: "petdudis-db2b2.firebasestorage.app",
  messagingSenderId: "410321083813",
  appId: "1:410321083813:web:eaf0082878a8281eab5c4c"
}; 
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cards
const totalEl = document.getElementById('totalParceiros');
const vipEl = document.getElementById('parceirosVIP');
const novosEl = document.getElementById('novosParceiros');
const emergentesEl = document.getElementById('emergentesParceiros');

// Gráficos
const graficoCategorias = new Chart(document.getElementById('graficoCategorias'), {
    type:'doughnut',
    data:{labels:[], datasets:[{data:[], backgroundColor:[]} ] },
    options:{responsive:true}
});
const graficoCrescimento = new Chart(document.getElementById('graficoCrescimento'), {
    type:'bar',
    data:{labels:[], datasets:[{label:'Compras Últimos Meses', data:[], backgroundColor:[]} ] },
    options:{responsive:true, plugins:{legend:{display:false}}}
});

// Atualiza lista de parceiros e gráficos
db.collection("parceiros").onSnapshot(snapshot => {
  const total = snapshot.size;
  const hoje = new Date();
  let vip = 0, novos = 0, emergentes = 0, proximosVIP = 0;
  let categorias = {};
  let labelsCrescimento = [], dataCrescimento = [], backgroundCrescimento = [];

  snapshot.forEach(doc => {
    const p = doc.data();
    const nome = p.nome || "Sem Nome";

    if(p.tipo==='VIP') vip++;

    const cadastro = p.cadastro && p.cadastro.toDate ? p.cadastro.toDate() : (p.cadastro ? new Date(p.cadastro) : null);
    if(cadastro && cadastro >= new Date(new Date().setMonth(new Date().getMonth()-1))) novos++;

    const totalCompras = p.comprasUltimosMeses ? p.comprasUltimosMeses.reduce((a,b)=>a+b,0) : 0;
    if(totalCompras >= 0.8 * (p.comprasVIP || 1000)) emergentes++;
    if(totalCompras >= 0.6 * (p.comprasVIP || 1000) && totalCompras < (p.comprasVIP || 1000)) proximosVIP++;

    const cat = p.categoria || "Outros";
    categorias[cat] = (categorias[cat] || 0)+1;

    labelsCrescimento.push(nome);
    dataCrescimento.push(totalCompras);
    if(totalCompras >= (p.comprasVIP || 1000)) backgroundCrescimento.push('#16a085');
    else if(totalCompras >= 0.6*(p.comprasVIP||1000)) backgroundCrescimento.push('#f39c12');
    else backgroundCrescimento.push('#2980b9');
  });

  totalEl.textContent = total;
  vipEl.textContent = vip;
  novosEl.textContent = novos;
  emergentesEl.textContent = emergentes;
  document.getElementById('proximosVIPs').textContent = proximosVIP;

  graficoCategorias.data.labels = Object.keys(categorias);
  graficoCategorias.data.datasets[0].data = Object.values(categorias);
  graficoCategorias.data.datasets[0].backgroundColor = Object.keys(categorias).map((v,i)=>`hsl(${i*60},70%,50%)`);
  graficoCategorias.update();

  graficoCrescimento.data.labels = labelsCrescimento;
  graficoCrescimento.data.datasets[0].data = dataCrescimento;
  graficoCrescimento.data.datasets[0].backgroundColor = backgroundCrescimento;
  graficoCrescimento.update();
});

// Modal
function abrirModal(){ document.getElementById('modalParceiro').style.display='flex'; }
function fecharModal(){ document.getElementById('modalParceiro').style.display='none'; }

// Tabs
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// ViaCEP
function buscarCEP(){
  const cepInput = document.getElementById('cep');
  const cep = (cepInput.value || '').replace(/\D/g,'');
  if(cep.length !== 8) return;
  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(r=>r.json())
    .then(d=>{
      if(d.erro) { alert('CEP não encontrado'); return; }
      document.getElementById('rua').value = d.logradouro || '';
      document.getElementById('bairro').value = d.bairro || '';
      document.getElementById('cidade').value = d.localidade || '';
      document.getElementById('estado').value = d.uf || '';
    })
    .catch(()=> alert('Erro ao buscar CEP'));
}

// Salvar parceiro
document.getElementById('formParceiro').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const nomeEmpresa = document.getElementById('nomeEmpresa').value.trim();
  const cnpjCpf = document.getElementById('cnpjCpf').value.trim();
  const telefoneEmpresa = document.getElementById('telefoneEmpresa').value.trim();
  const website = document.getElementById('website').value.trim();

  const cep = document.getElementById('cep').value.trim();
  const rua = document.getElementById('rua').value.trim();
  const numero = document.getElementById('numero').value.trim();
  const bairro = document.getElementById('bairro').value.trim();
  const cidade = document.getElementById('cidade').value.trim();
  const estado = document.getElementById('estado').value.trim();

  const servicos = {
    banhoTosa: document.getElementById('srvBanhoTosa').checked,
    creche: document.getElementById('srvCreche').checked,
    hospedagem: document.getElementById('srvHospedagem').checked,
    dogWalker: document.getElementById('srvDogWalker').checked,
    petSitter: document.getElementById('srvPetSitter').checked,
    adestramento: document.getElementById('srvAdestramento').checked,
    outros: document.getElementById('srvOutros').checked,
    outrosDescricao: document.getElementById('descricaoOutros').value.trim()
  };

  const responsavel = {
    nome: document.getElementById('respNome').value.trim(),
    telefone: document.getElementById('respTelefone').value.trim(),
    email: document.getElementById('respEmail').value.trim(),
    cargo: document.getElementById('respCargo').value.trim()
  };

  const financeiro = {
    faixaFaturamento: document.getElementById('faixaFaturamento').value.trim(),
    formasPagamento: document.getElementById('formasPagamento').value.trim(),
    limiteCredito: document.getElementById('limiteCredito').value.trim(),
    observacoes: document.getElementById('observacoes').value.trim(),
    status: document.getElementById('statusParceiro').value
  };

  if(!nomeEmpresa || !cnpjCpf || !cep){
    alert('Preencha ao menos Nome da Empresa, CNPJ/CPF e CEP.');
    return;
  }

  const parceiro = {
    nomeEmpresa,
    nome: nomeEmpresa,
    cnpjCpf,
    telefoneEmpresa,
    website,
    endereco: { cep, rua, numero, bairro, cidade, estado },
    servicos,
    responsavel,
    financeiro,
    cadastro: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await db.collection('parceiros').add(parceiro);
    alert('Parceiro salvo com sucesso!');
    e.target.reset();
    document.querySelectorAll('.tabBtn')[0].click(); // volta para aba Empresa
    fecharModal();
  }catch(err){
    alert('Erro ao salvar: ' + err.message);
  }
});
</script>
</body>
</html>
